<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraction extraction-result-3746 - Theorizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="header">
        <a href="../index.html"><i class="fas fa-flask"></i> Theorizer</a>
    </div>

    <div class="content">
        <h1>Extracted Data Details for extraction-result-3746</h1>

        <div class="section">
            <h2>Extracted Data (Header)</h2>
            <div class="info-section">
                <p><strong>Extraction ID:</strong> extraction-result-3746</p>
                <p><strong>Extraction Schema Used (ID):</strong> <a href="../schemas/extraction-schema-89.html">extraction-schema-89</a></p>
                <div class="extraction-query"><strong>Extraction Query:</strong> Extract any mentions of large language models (LLMs) or related AI systems being used to distill, extract, or induce qualitative laws, rules, or scientific principles from large collections of scholarly or scientific papers.</div>
                <p><strong>Paper ID:</strong> paper-f5359f596e0306599b4aa4157e6fe03567b35c01</p>
                <p><strong>Paper Title:</strong> <a href="https://www.semanticscholar.org/paper/f5359f596e0306599b4aa4157e6fe03567b35c01" target="_blank">Knowledge Distillation of Large Language Models</a></p>
                <p><strong>Paper Venue:</strong> International Conference on Learning Representations</p>
                <p><strong>Paper TL;DR:</strong> This work replaces the forward Kullback-Leibler divergence (KLD) objective in the standard KD approaches with reverse KLD, which is more suitable for KD on generative language models, to prevent the student model from overestimating the low-probability regions of the teacher distribution.</p>
                <p><strong>Paper Abstract:</strong> Knowledge Distillation (KD) is a promising technique for reducing the high computational demand of large language models (LLMs). However, previous KD methods are primarily applied to white-box classification models or training small models to imitate black-box model APIs like ChatGPT. How to effectively distill the knowledge of white-box LLMs into small models is still under-explored, which becomes more important with the prosperity of open-source LLMs. In this work, we propose a KD approach that distills LLMs into smaller language models. We first replace the forward Kullback-Leibler divergence (KLD) objective in the standard KD approaches with reverse KLD, which is more suitable for KD on generative language models, to prevent the student model from overestimating the low-probability regions of the teacher distribution. Then, we derive an effective optimization approach to learn this objective. The student models are named MiniLLM. Extensive experiments in the instruction-following setting show that MiniLLM generates more precise responses with higher overall quality, lower exposure bias, better calibration, and higher long-text generation performance than the baselines. Our method is scalable for different model families with 120M to 13B parameters. Our code, data, and model checkpoints can be found in https://github.com/microsoft/LMOps/tree/main/minillm.</p>
                <p><strong>Cost:</strong> 0.007</p>
            </div>
        </div>

        <div class="section">
            <h2>Extracted Data (Details)</h2>
            <p class="empty-note">No extracted data.</p>
        </div>

        <div class="section">
            <h2>Potentially Relevant New Papers (mentioned by this paper)</h2>
            <p class="empty-note">No potentially relevant new papers extracted.</p>
        </div>

        <div class="section">
            <h2>Extracted Data (Debug)</h2>
            <pre><code>{
    "id": "extraction-result-3746",
    "paper_id": "paper-f5359f596e0306599b4aa4157e6fe03567b35c01",
    "extraction_schema_id": "extraction-schema-89",
    "extracted_data": [],
    "potentially_relevant_new_papers": [],
    "cost": 0.0069229999999999995,
    "model_str": "gpt-5-mini"
}</code></pre>
        </div>
        <div class="section">
            <h2>Paper</h2>
            <div class="paper-content"><h1>MiniLLM: Knowledge Distillation of Large Language Models</h1>
<p>Yuxian Gu ${ }^{1,2}$, Li Dong ${ }^{2}$, Furu Wei ${ }^{2}$, Minlie Huang ${ }^{1 \dagger}$<br>${ }^{1}$ The CoAI Group, Tsinghua University<br>${ }^{2}$ Microsoft Research<br>guyx21@mails.tsinghua.edu.cn {lidong1,fuwei}@microsoft.com<br>aihuang@tsinghua.edu.cn</p>
<h4>Abstract</h4>
<p>Knowledge Distillation (KD) is a promising technique for reducing the high computational demand of large language models (LLMs). However, previous KD methods are primarily applied to white-box classification models or training small models to imitate black-box model APIs like ChatGPT. How to effectively distill the knowledge of white-box LLMs into small models is still under-explored, which becomes more important with the prosperity of open-source LLMs. In this work, we propose a KD approach that distills LLMs into smaller language models. We first replace the forward Kullback-Leibler divergence (KLD) objective in the standard KD approaches with reverse KLD, which is more suitable for KD on generative language models, to prevent the student model from overestimating the low-probability regions of the teacher distribution. Then, we derive an effective optimization approach to learn this objective. The student models are named MiniLLM. Extensive experiments in the instruction-following setting show that MiniLLM generates more precise responses with higher overall quality, lower exposure bias, better calibration, and higher long-text generation performance than the baselines. Our method is scalable for different model families with 120 M to 13 B parameters. Our code, data, and model checkpoints can be found in https://github.com/microsoft/LMDps/tree/main/minillm.</p>
<p><img alt="img-0.jpeg" src="img-0.jpeg" /></p>
<p>Figure 1: The comparison of MiniLLM with the sequence-level KD (SeqKD; KR16, TGZ ${ }^{+} 23$, $\mathrm{CLL}^{+} 23, \mathrm{PLH}^{+} 23, \mathrm{GWS}^{+} 23, \mathrm{ZLX}^{+} 23$ ) in terms of the average GPT-4 feedback score on our evaluation sets. Left: GPT-2-1.5B as the teacher model and GPT-2 125M, 340M, 760M as the student models. Middle: GPT-J 6B as the teacher model and GPT-2 760M, 1.5B, GPT-Neo 2.7B as the student models. Right: OPT 13B as the teacher and OPT 1.3B, 2.7B, 6.7B as the student models.</p>
<p><sup id="fnref:0"><a class="footnote-ref" href="#fn:0">1</a></sup></p>
<p>1 Introduction</p>
<p>With the rapid development of large language models (LLMs; BMR${}^{+}{20}$, HZD${}^{+}{21}$, BHA${}^{+}{21}$, CND${}^{+}{22}$, Ope23), a common technique to reduce their high computational resource demand is knowledge distillation (KD; HVD15), where we train a small student model with supervision from a large teacher model. Two categories of KD are commonly applied: black-box KD, where only the teacher-generated texts are accessible, and white-box KD, where the teacher model’s output distribution or intermediate hidden states are also available [JBMD21]. Recently, black-box KD has shown promising results in fine-tuning small models on the prompt-response pairs generated by LLM APIs [TGZ${}^{+}{23}$, CLL${}^{+}{23}$, WWZ${}^{+}{23}$, PLH${}^{+}{23}$]. With the emergence of more open-source LLMs [ZRG${}^{+}{22}$, TLI${}^{+}{23}$], white-box KD becomes more valuable for both research communities and industry sectors because student models receive better signals from the output distribution and hidden states of teacher models, thereby potentially resulting in higher performance. However, white-box KD approaches are mostly studied for small ( $&lt;1$B parameters) language understanding models [SDCW19, WWD${}^{+}{20}$], while white-box KD for LLMs is yet to be explored.</p>
<p>In this work, we investigate white-box KD of LLMs where the output distribution of the teacher model is available. We argue that the standard KD objectives [KR16, SST${}^{+}{20}$, CLL${}^{+}{23}$, TGZ${}^{+}{23}$] are sub-optimal for LLMs that perform tasks in a generative manner. Given the teacher distribution $p(\boldsymbol{y}|\boldsymbol{x})$ and the student distribution $q_{\theta}(\boldsymbol{y}|\boldsymbol{x})$ parameterized by $\theta$, standard KD objectives (including several variants for sequence-level models) essentially minimize the approximated forward Kullback-Leibler divergence (KLD) between the teacher and the student distribution, termed as $\mathrm{KL}[p||q_{\theta}]$, which forces $q_{\theta}$ to cover all modes of $p$. For text classification tasks, $\mathrm{KL}[p||q_{\theta}]$ works well because the output space usually consists of a finite number of classes such that both $p(\boldsymbol{y}|\boldsymbol{x})$ and $q_{\theta}(\boldsymbol{y}|\boldsymbol{x})$ have few modes. However, for open-ended text generation tasks, which is usually the case of LLM applications, the output spaces are much more complex and $p(\boldsymbol{y}|\boldsymbol{x})$ can contain many more modes than what $q_{\theta}(\boldsymbol{y}|\boldsymbol{x})$ can express due to the limited model capacity. Minimizing forward KLD causes $q_{\theta}$ to assign unreasonably high probabilities to the void regions of $p$ [MG19] and produces very unlikely samples under $p$ during free-run generation [Hus15].</p>
<p>To alleviate this problem, we propose to minimize reverse KLD, $\mathrm{KL}[q_{\theta}||p]$, widely used in computer vision [LPSK23] and reinforcement learning [CPO${}^{+}{19}$]. Compared to $\mathrm{KL}[p||q_{\theta}]$, minimizing $\mathrm{KL}[q_{\theta}||p]$ causes $q_{\theta}$ to seek the major modes of $p$, and assign low probabilities to $p$’s void regions [M${}^{+}{05}$], as illustrated in Table 2 and discussed in Section 2.1. In LLM text generation, this means that the student model avoids learning too many long-tail variants [HBD${}^{+}{20}$] in the teacher model’s distribution and focuses on the correctness of the generated cotents, which is critical in practical scenarios that require truthfulness and reliability [JLF${}^{+}{23}$]. To optimize $\min_{\theta}\mathrm{KL}[q_{\theta}||p]$, as shown in Section 2.2, we derive the gradient of the objective with Policy Gradient [SMSM99]. To further stabilize and accelerate training, we propose (1) single-step decomposition to reduce variance, (2) teacher-mixed sampling to alleviate reward hacking, and (3) length normalization to eliminate the length bias. Finally, we introduce the overall KD algorithm in Section 2.3. Our student models are named MiniLLM, indicating our method is suitable and works well for compressing large (generative) language models.</p>
<p>We apply our method to various generative language models [RWC${}^{+}{19}$, ZRG${}^{+}{22}$, TLI${}^{+}{23}$] with sizes ranging from 120M to 13B in the instruction-following setting [SWR${}^{+}{22}$, WBZ${}^{+}{22}$] that covers a large range of NLP tasks. We use 5 datasets with Rouge-L [Lin04], the GPT-4 feedback, and human judgment for evaluation. Experiments show that MiniLLM consistently outperforms standard KD baselines on all the datasets and scales up well from 120M to 13B models (see Figure 1). More analysis shows that MiniLLM yields lower exposure bias, better calibration, and higher long response generation performance, with neglectable loss of diversity.</p>
<h2>2 Method</h2>
<p>We consider conditional text generation where the model produces a response $\boldsymbol{y}={y_{t}}<em _boldsymbol_x="\boldsymbol{x">{t=1}^{T}$ conditioning on a prompt $\boldsymbol{x}$ sampled from the distribution $p</em>$, which is typically how LLMs perform tasks.}</p>
<p><img alt="img-1.jpeg" src="img-1.jpeg" /></p>
<p>Figure 3: Comparison between sequence-level KD (left) and MINILLM (right). Sequence-level KD forces the student to memorize all samples generated by the teacher model, while MINILLM improves its generated texts with the teacher model's feedback.</p>
<p>We formulate KD as an optimization problem to minimize the difference between a fixed teacher model distribution $p(\boldsymbol{y}|\boldsymbol{x})$ and a student model distribution $q_{\theta}(\boldsymbol{y}|\boldsymbol{x})$ parameterized by $\theta$. The standard KD methods approximately<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">2</a></sup> minimize the <em>forward</em> KLD: $\mathrm{KL}[p| |q_{\theta}]=\mathbb{E}<em _boldsymbol_x="\boldsymbol{x">{\boldsymbol{x} \sim p</em>$ is insufficiently expressive [JKH+23]. KD for LLMs fits the case because LLMs perform tasks in a generative manner, such that the low-capacity student models cannot perfectly imitate the complex text generation distribution of the teacher models or humans.}}, \boldsymbol{y} \sim p^{\prime}} \log \frac{p(\boldsymbol{y}|\boldsymbol{x})}{q_{\theta}(\boldsymbol{y}|\boldsymbol{x})}$, where $p^{\prime}$ can be real data distribution (word-level KD) or teacher distribution $p$ (sequence-level KD). Though widely used, $\mathrm{KL}[p| |q_{\theta}]$ tends to overestimate the void regions of $p$ in text generation tasks when $q_{\theta</p>
<h3>2.1 MINILLM: Knowledge Distillation with <em>Reverse</em> KLD</h3>
<p>We consider minimizing the <em>reverse</em> KLD between the student and teacher model distributions as the learning objective for MINILLM:</p>
<p>$$
\begin{aligned}
\theta = \arg\min_{\theta}\mathcal{L}(\theta) &amp;= \arg\min_{\theta} \mathrm{KL}[q_{\theta}| |p] \
&amp;= \arg\min_{\theta} \left[ -\underset{\boldsymbol{x} \sim p_{\boldsymbol{x}}, \boldsymbol{y} \sim q_{\theta}}{\mathbb{E}} \log \frac{p(\boldsymbol{y}|\boldsymbol{x})}{q_{\theta}(\boldsymbol{y}|\boldsymbol{x})} \right].
\end{aligned}
\tag{1}
$$</p>
<p>Minimizing <em>reverse</em> KLD has been shown to cause the mode-seeking behavior in generative modeling [Hus15, NCT16, CDP+18, LPSK23], where $q_{\theta}$ assigns high probabilities to $p$'s large modes and ignore the small ones (illustrated in a toy experiment in Figure 2). In this work, we first study this property for KD of LLMs in text generation. Minimizing <em>forward</em> KLD causes $q_{\theta}$ to place large probability masses on the zero-probability regions of $p$, corresponding to the generation of low-quality text in practice, while <em>reverse</em> KLD focuses on $p$'s major modes, which is crucial to ensure the correctness and faithfulness of text generation. As illustrated in Figure 3, unlike sequence-level KD that minimizes <em>forward</em> KLD [KR16, TGZ+23], MINILLM that minimizes <em>reverse</em> KLD does not force $q_{\theta}$ to fit all $\boldsymbol{y}$ sampled from the teacher distribution $p$. Instead, it encourages the student to generate samples preferred by the teacher within its own capacities, which is more possible to achieve. Interestingly, we also find another perspective of understanding MINILLM motivated by Inverse Reinforcement Learning [ZMB+08]. We present the related derivation in Appendix A.1.</p>
<h3>2.2 Optimization with Policy Gradient</h3>
<p><strong>Gradient Derivation</strong> We notice that the gradient of the objective function $\mathcal{L}(\theta)$ in Equation (1) can be derived using the Policy Gradient Theorem [Wil92, HTAL17]:</p>
<p>$$
\nabla\mathcal{L}(\theta) = -\underset{\boldsymbol{x} \sim p_{\boldsymbol{x}}, \boldsymbol{y} \sim q_{\theta}(\cdot|\boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T} (R_t - 1) \nabla \log q_{\theta}(y_t | \boldsymbol{y}_{&lt;t}, \boldsymbol{x}), \tag{2}
$$</p>
<p>where $T = |\boldsymbol{y}|$ and $R_t = \sum_{t' = t}^T \log \frac{p(y_t' | \boldsymbol{y}<em _theta="\theta">{&lt;t'}, \boldsymbol{x})}{q</em>}(y_t' | \boldsymbol{y<em _t_="&lt;t'">{&lt;t'}, \boldsymbol{x})}$ is the accumulation of $r_t' = \log \frac{p(y_t' | \boldsymbol{y}</em>}, \boldsymbol{x})}{q_{\theta}(y_t' | \boldsymbol{y<em _t_="&lt;t'">{&lt;t'}, \boldsymbol{x})}$ that measures the quality of each step's generation. Intuitively, the generated texts are supposed to have high probabilities under the teacher distribution by increasing $p(y_t' | \boldsymbol{y}</em>)$. The expectation in Eq. 2 is computed by Monte-Carlo sampling. Full derivation can be found in Appendix A.2. However, policy gradient suffers from high variance and reward hacking [SHKK22], despite some subsequent solutions [SWD+17]. Besides, we notice that $R_t$ favors short sentences, which causes the student model to output empty responses. Therefore, we propose three strategies to mitigate these problems.}, \boldsymbol{x})$, but simultaneously stay diverse by lowering $q_{\theta}(y_t' | \boldsymbol{y}_{&lt;t'}, \boldsymbol{x</p>
<p>Single-Step Decomposition [CPO+19] has found that the single-step generation quality $r_{t}$ is critical to the training variance because the error in the front tokens accumulates along the whole sentence. To pay more attention to $r_{t}$, we re-write $\nabla\mathcal{L}(\theta)$ to decompose $r_{t}$ from $R_{t}$ and directly compute the gradient of $\mathbb{E}<em t="t">{y</em>]$ (see Appendix A.3 for the full derivation):}\sim q_{\theta}(t)}[r_{t</p>
<p>$$
\begin{aligned}
\nabla \mathcal{L}(\theta) &amp; =\underset{\boldsymbol{x} \sim p_{\boldsymbol{x}}}{\mathbb{E}} \mathbb{E}<em _boldsymbol_x="\boldsymbol{x">{y</em> \
y_{t} \sim q_{\theta}(: \mid \boldsymbol{x})}}{\mathbb{E}}\left[r_{t}\right]\right]+\underset{\boldsymbol{x} \sim p_{\boldsymbol{x}}}{\mathbb{E}} \quad\left[-\sum_{t=1}^{T} R_{t+1} \nabla \log q_{\theta}\left(y_{t} \mid \boldsymbol{y}}}} \quad\left[-\sum_{t=1}^{T} \nabla \underset{\substack{\boldsymbol{x<em _Single="{Single" _text="\text">{&lt;t}, \boldsymbol{x}\right)\right] \
&amp; =(\nabla \mathcal{L})</em>
\end{aligned}
$$}}+(\nabla \mathcal{L})_{\text {Long }</p>
<p>where $q_{\theta}(t)=q_{\theta}\left(\cdot \mid \boldsymbol{y}<em y__t="y_{t">{&lt;t}, \boldsymbol{x}\right)$. Note that $\mathbb{E}</em>\right]$ can be computed directly by summing over the vocabulary instead of using Monte-Carlo sampling and is derivable with respect to $\theta$. This decomposition gives a more precise and efficient estimation of the single-step generation quality, which reduces the variance during training and accelerates convergence.} \sim q_{\theta}(t)}\left[r_{t</p>
<p>Teacher-Mixed Sampling We observe reward hacking [SHKK22] when training with Eq. 2 because $q_{\theta}$ sometimes produces degenerated sentences $\boldsymbol{y}$ that receive high scores from the teacher (e.g., repeated phrases) during sampling, especially for small student models. To create a better sampling distribution, we mix the teacher and the student distribution at each time step:</p>
<p>$$
\widetilde{p}\left(y_{t} \mid \boldsymbol{y}<em t="t">{&lt;t}, \boldsymbol{x}\right)=\alpha \cdot p\left(y</em>} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)+(1-\alpha) \cdot q</em>\right)
$$}\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x</p>
<p>where $\alpha$ controls the strength of the teacher mix-in. Sampling from $\widetilde{p}$ suppresses low-quality generation with the teacher's help and alleviates reward hacking. We re-write $(\nabla \mathcal{L})<em _Long="{Long" _text="\text">{\text {Single }}$ and $(\nabla \mathcal{L})</em>$ with importance sampling to get to an unbiased estimator of the gradient [PSS00]:}</p>
<p>$$
\begin{aligned}
(\nabla \mathcal{L})<em _boldsymbol_x="\boldsymbol{x">{\text {Single }} &amp; =-\underset{\boldsymbol{x} \sim p</em>\right]\right] \
(\nabla \mathcal{L})}}, \boldsymbol{y} \sim \widetilde{p}(\cdot \mid \boldsymbol{x})}{\mathbb{E}}\left[\sum_{t=1}^{T} w_{t} \nabla \underset{\substack{y_{t} \sim q_{\theta}(t)}}{\mathbb{E}}\left[r_{t<em _boldsymbol_x="\boldsymbol{x">{\text {Long }} &amp; =-\underset{\boldsymbol{x} \sim p</em>\right)\right]
\end{aligned}
$$}}, \boldsymbol{y} \sim \widetilde{p}(\cdot \mid \boldsymbol{x})}{\mathbb{E}}\left[\sum_{t=1}^{T} w_{t} R_{t+1} \nabla \log q_{\theta}\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x</p>
<p>where $w_{t}=\prod_{t^{\prime}=1}^{t} \frac{q_{\theta}\left(y_{t^{\prime}} \mid \boldsymbol{y}<em t_prime="t^{\prime">{&lt;t^{\prime}}, \boldsymbol{x}\right)}{\widetilde{p}\left(y</em>}} \mid \boldsymbol{y<em t="t">{&lt;t^{\prime}}, \boldsymbol{x}\right)}$ is the importance weight. However, $w</em>}$ brings high variance in practice because it requires multiplying per-token importance weight over multiple time steps, and thus the variance of each step accumulates. Therefore, we approximately set $w_{t} \approx \frac{q_{\theta}\left(y_{t} \mid \boldsymbol{y<em t="t">{&lt;t}, \boldsymbol{x}\right)}{\widetilde{p}\left(y</em>$ to reduce the variance of the estimator in Eq. 5 [SSG+17, LKTF20].} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)</p>
<p>Length Normalization We found that long sequences tend to have small $R_{t+1}$, which encourages the model to produce short responses. Therefore, we add length normalization to $R_{t+1}$ in Eq. 3:</p>
<p>$$
R_{t+1}^{\text {Norm }}=\frac{1}{T-t-1} \sum_{t^{\prime}=t+1}^{T} \log \frac{p\left(y_{t^{\prime}} \mid \boldsymbol{y}<em _theta="\theta">{&lt;t^{\prime}}, \boldsymbol{x}\right)}{q</em>
$$}\left(y_{t^{\prime}} \mid \boldsymbol{y}_{&lt;t^{\prime}}, \boldsymbol{x}\right)</p>
<p>In Summary Combining the strategies listed above, we have the final optimization gradient:</p>
<p>$$
\nabla \mathcal{L}(\theta)=-\underset{\substack{\boldsymbol{x} \sim p_{\boldsymbol{x}}} \
\boldsymbol{y} \sim \widetilde{p}(\cdot \mid \boldsymbol{x})}}{\mathbb{E}}\left[\sum_{t=1}^{T} w_{t}\left[\underbrace{\nabla \sum_{y^{\prime} \in V} q_{\theta}\left(y^{\prime} \mid \boldsymbol{y}<em _t="&lt;t">{&lt;t}, \boldsymbol{x}\right) \log \frac{p\left(y^{\prime} \mid \boldsymbol{y}</em>}, \boldsymbol{x}\right)}{q_{\theta}\left(y^{\prime} \mid \boldsymbol{y<em _left_nabla="\left(\nabla" _mathcal_L="\mathcal{L">{&lt;t}, \boldsymbol{x}\right)}}</em>\right)<em t_1="t+1">{\text {Single part }}}+\underbrace{R</em>}^{\text {Norm }} \frac{\nabla q_{\theta}\left(y_{t} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}{q</em>}\left(y_{t} \mid \boldsymbol{y<em _left_nabla="\left(\nabla" _mathcal_L="\mathcal{L">{&lt;t}, \boldsymbol{x}\right)}}</em>\right]\right]
$$}\right)_{\text {Long }}^{\text {Norm part }</p>
<p>where $V$ is the vocabulary size of the language model and $(\nabla \mathcal{L})<em _Long="{Long" _text="\text">{\text {Long }}^{\text {Norm }}$ is $(\nabla \mathcal{L})</em>$.}}$ with $R_{t+1}^{\text {Norm }</p>
<h1>2.3 Training Algorithm</h1>
<p>We start from a student model pre-trained on a large long-document corpus $\mathcal{D}<em _Single="{Single" _text="\text">{\text {PT }}$. Algorithm 2.3 trains MiniLLM by adapting the student model to a text generation task with dataset $\mathcal{D}$ and supervision from the teacher model, such as an LLM fine-tuned on $\mathcal{D}\left[\mathrm{TGZ}^{+} 23, \mathrm{CLL}^{+} 23\right]$ or that with good task-generalization [CHL+22, Ope23]. In the training algorithm, we first fine-tune the student model on $\mathcal{D}$ and pick the checkpoint with the lowest loss as an initialization for the following training. Then, we compute the gradients $(\nabla \mathcal{L})</em>$ based on Eq. 5 and Eq.}}$ and $(\nabla \mathcal{L})_{\text {Long }}^{\text {Norm }</p>
<p>6, with a clipping strategy [SWD+17] added to further improve stability. Same as [OWJ+22], we include a language modeling loss $\mathcal{L}<em _boldsymbol_d="\boldsymbol{d">{\mathrm{PT}}=-\mathbb{E}</em>} \sim \mathcal{D<em _theta="\theta">{\mathrm{PT}}} \log q</em>)}(\boldsymbol{d})$ to preserve the model performance on canonical NLP benchmarks. The student model is finally updated using a combination of gradients $(\nabla \mathcal{L<em _Long="{Long" _text="\text">{\text {Single }}+(\nabla \mathcal{L})</em> 22$ ).}}^{\text {Norm }}+\nabla \mathcal{L}_{\mathrm{PT}}$. The whole training pipeline is similar to Reinforcement Learning from Human Feedback (RLHF; OWJ ${ }^{+</p>
<div class="codehilite"><pre><span></span><code><span class="nt">Algorithm</span><span class="w"> </span><span class="nt">1</span><span class="w"> </span><span class="nt">MinILLM</span><span class="o">:</span><span class="w"> </span><span class="nt">Knowledge</span><span class="w"> </span><span class="nt">Distillation</span><span class="w"> </span><span class="nt">of</span><span class="w"> </span><span class="nt">LLMs</span>
<span class="nt">Input</span><span class="o">:</span><span class="w"> </span><span class="nt">Conditional</span><span class="w"> </span><span class="nt">generation</span><span class="w"> </span><span class="nt">dataset</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">consisting</span><span class="w"> </span><span class="nt">of</span><span class="w"> </span><span class="nt">prompts</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">ground-truth</span><span class="w"> </span><span class="nt">responses</span>
<span class="w">    </span><span class="nt">Pre-training</span><span class="w"> </span><span class="nt">corpus</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">\mathrm{PT</span><span class="p">}</span><span class="err">}\</span><span class="o">)</span><span class="w"> </span><span class="nt">consisting</span><span class="w"> </span><span class="nt">of</span><span class="w"> </span><span class="nt">long-document</span><span class="w"> </span><span class="nt">plain</span><span class="w"> </span><span class="nt">texts</span>
<span class="w">    </span><span class="nt">A</span><span class="w"> </span><span class="nt">teacher</span><span class="w"> </span><span class="nt">model</span><span class="w"> </span><span class="nt">with</span><span class="w"> </span><span class="nt">output</span><span class="w"> </span><span class="nt">distribution</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="nt">p</span><span class="err">\</span><span class="o">)</span>
<span class="w">    </span><span class="nt">An</span><span class="w"> </span><span class="nt">initial</span><span class="w"> </span><span class="nt">student</span><span class="w"> </span><span class="nt">model</span><span class="w"> </span><span class="nt">pre-trained</span><span class="w"> </span><span class="nt">on</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">\mathrm{PT</span><span class="p">}</span><span class="err">}\</span><span class="o">),</span><span class="w"> </span><span class="nt">with</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">output</span><span class="w"> </span><span class="nt">distribution</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="nt">q_</span><span class="p">{</span><span class="err">\theta_{0</span><span class="p">}</span><span class="err">}\</span><span class="o">)</span>
<span class="w">    </span><span class="nt">Learning</span><span class="w"> </span><span class="nt">rate</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">eta</span><span class="w"> </span><span class="o">;</span><span class="w"> </span><span class="err">\</span><span class="nt">quad</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">Batch</span><span class="w"> </span><span class="nt">size</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="nt">M</span><span class="w"> </span><span class="o">;</span><span class="w"> </span><span class="err">\</span><span class="nt">quad</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">Clipping</span><span class="w"> </span><span class="nt">Threshold</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">epsilon</span><span class="err">\</span><span class="o">)</span>
<span class="nt">Output</span><span class="o">:</span><span class="w"> </span><span class="nt">A</span><span class="w"> </span><span class="nt">student</span><span class="w"> </span><span class="nt">model</span><span class="w"> </span><span class="nt">with</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">output</span><span class="w"> </span><span class="nt">distribution</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="nt">q_</span><span class="p">{</span><span class="err">\theta</span><span class="p">}</span><span class="err">\</span><span class="o">)</span>
<span class="w">    </span><span class="nt">Fine-tune</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">student</span><span class="w"> </span><span class="nt">model</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">theta_</span><span class="p">{</span><span class="err">0</span><span class="p">}</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">on</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">supervised</span><span class="w"> </span><span class="nt">by</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">ground</span><span class="w"> </span><span class="nt">truth</span><span class="w"> </span><span class="nt">responses</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">choose</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">theta</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">with</span><span class="w"> </span><span class="nt">the</span>
<span class="w">    </span><span class="nt">lowest</span><span class="w"> </span><span class="nt">validation</span><span class="w"> </span><span class="nt">loss</span><span class="o">.</span>
<span class="w">    </span><span class="nt">repeat</span>
<span class="w">        </span><span class="nt">Sample</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">mini-batch</span><span class="w"> </span><span class="nt">of</span><span class="w"> </span><span class="nt">prompts</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">collect</span><span class="w"> </span><span class="nt">responses</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">widetilde</span><span class="p">{</span><span class="err">p</span><span class="p">}</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">to</span><span class="w"> </span><span class="nt">get</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">S</span><span class="p">}</span><span class="o">=</span><span class="err">\</span><span class="nt">left</span><span class="err">\</span><span class="p">{</span><span class="err">\left(\boldsymbol{x</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">m</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">m</span><span class="p">}</span><span class="err">\</span><span class="nt">right</span><span class="o">)</span><span class="err">\</span><span class="nt">right</span><span class="err">\}</span><span class="nt">_</span><span class="p">{</span><span class="err">m=1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">M</span><span class="p">}</span><span class="err">\</span><span class="o">)</span>
<span class="w">        </span><span class="nt">Sample</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">mini-batch</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">P</span><span class="w"> </span><span class="err">T</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">\prime</span><span class="p">}</span><span class="o">=</span><span class="err">\</span><span class="nt">left</span><span class="err">\</span><span class="p">{</span><span class="err">\boldsymbol{d</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">m</span><span class="p">}</span><span class="err">\</span><span class="nt">right</span><span class="err">\}</span><span class="nt">_</span><span class="p">{</span><span class="err">m=1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">M</span><span class="p">}</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">\mathrm{PT</span><span class="p">}</span><span class="err">}\</span><span class="o">)</span>
<span class="w">        </span><span class="nt">Compute</span><span class="w"> </span><span class="err">\</span><span class="o">((</span><span class="err">\</span><span class="nt">nabla</span><span class="w"> </span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">L</span><span class="p">}</span><span class="o">)</span><span class="nt">_</span><span class="p">{</span><span class="err">\text</span><span class="w"> </span><span class="err">{Single</span><span class="w"> </span><span class="p">}</span><span class="err">}</span><span class="o">=</span><span class="nt">-</span><span class="err">\</span><span class="nt">frac</span><span class="p">{</span><span class="err">1</span><span class="p">}{</span><span class="err">M</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">sum_</span><span class="p">{</span><span class="err">\boldsymbol{x</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">in</span><span class="w"> </span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">S</span><span class="p">}</span><span class="err">}</span><span class="w"> </span><span class="err">\</span><span class="nt">sum_</span><span class="p">{</span><span class="err">t=1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">T</span><span class="p">}</span><span class="w"> </span><span class="nt">w_</span><span class="p">{</span><span class="err">t</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">nabla</span><span class="w"> </span><span class="err">\</span><span class="nt">sum_</span><span class="p">{</span><span class="err">y_{t</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">in</span><span class="w"> </span><span class="nt">V</span><span class="err">}</span><span class="w"> </span><span class="nt">q_</span><span class="p">{</span><span class="err">\theta</span><span class="p">}</span><span class="err">\</span><span class="nt">left</span><span class="o">(</span><span class="nt">y_</span><span class="p">{</span><span class="err">t</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">mid</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">&lt;t</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">x</span><span class="p">}</span><span class="err">\</span><span class="nt">right</span><span class="o">)</span><span class="w"> </span><span class="err">\</span><span class="nt">log</span><span class="w"> </span><span class="err">\</span><span class="nt">frac</span><span class="p">{</span><span class="err">p\left(y_{t</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">mid</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">&lt;t</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">x</span><span class="p">}</span><span class="err">\</span><span class="nt">right</span><span class="o">)</span><span class="err">}</span><span class="p">{</span><span class="err">q_{\theta</span><span class="p">}</span><span class="err">\</span><span class="nt">left</span><span class="o">(</span><span class="nt">y_</span><span class="p">{</span><span class="err">t</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">mid</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">&lt;t</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">x</span><span class="p">}</span><span class="err">\</span><span class="nt">right</span><span class="o">)</span><span class="err">}</span><span class="w"> </span><span class="err">\</span><span class="nt">quad</span><span class="w"> </span><span class="err">\</span><span class="nt">triangleright</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">Eq</span><span class="o">.</span><span class="w"> </span><span class="nt">5</span>
<span class="w">        </span><span class="nt">Compute</span><span class="w"> </span><span class="err">\</span><span class="o">((</span><span class="err">\</span><span class="nt">nabla</span><span class="w"> </span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">L</span><span class="p">}</span><span class="o">)</span><span class="nt">_</span><span class="p">{</span><span class="err">\text</span><span class="w"> </span><span class="err">{Long</span><span class="w"> </span><span class="p">}</span><span class="err">}</span><span class="o">^</span><span class="p">{</span><span class="err">\text</span><span class="w"> </span><span class="err">{Norm</span><span class="w"> </span><span class="p">}</span><span class="err">}</span><span class="o">=</span><span class="nt">-</span><span class="err">\</span><span class="nt">frac</span><span class="p">{</span><span class="err">1</span><span class="p">}{</span><span class="err">|M|</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">sum_</span><span class="p">{</span><span class="err">\boldsymbol{x</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">in</span><span class="w"> </span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">S</span><span class="p">}</span><span class="err">}</span><span class="w"> </span><span class="err">\</span><span class="nt">sum_</span><span class="p">{</span><span class="err">t=1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="err">T</span><span class="p">}</span><span class="w"> </span><span class="nt">R_</span><span class="p">{</span><span class="err">\mathrm{t</span><span class="p">}</span><span class="o">+</span><span class="nt">1</span><span class="err">}</span><span class="o">^</span><span class="p">{</span><span class="err">\text</span><span class="w"> </span><span class="err">{Norm</span><span class="w"> </span><span class="p">}</span><span class="err">}</span><span class="w"> </span><span class="err">\</span><span class="nt">nabla</span><span class="w"> </span><span class="err">\</span><span class="nt">min</span><span class="w"> </span><span class="err">\</span><span class="nt">left</span><span class="cp">[</span><span class="o">\</span><span class="nx">rho_</span><span class="p">{</span><span class="nx">t</span><span class="p">}(</span><span class="o">\</span><span class="nx">theta</span><span class="p">),</span><span class="o">\</span><span class="nx">operatorname</span><span class="p">{</span><span class="nx">clip</span><span class="p">}</span><span class="o">\</span><span class="nx">left</span><span class="p">(</span><span class="o">\</span><span class="nx">rho_</span><span class="p">{</span><span class="nx">t</span><span class="p">}(</span><span class="o">\</span><span class="nx">theta</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="o">-\</span><span class="nx">epsilon</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">+\</span><span class="nx">epsilon</span><span class="o">\</span><span class="nx">right</span><span class="p">)</span><span class="o">\</span><span class="nx">right</span><span class="cp">]</span><span class="err">，</span>
<span class="w">        </span><span class="nt">where</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">rho_</span><span class="p">{</span><span class="err">t</span><span class="p">}</span><span class="o">(</span><span class="err">\</span><span class="nt">theta</span><span class="o">)=</span><span class="err">\</span><span class="nt">frac</span><span class="p">{</span><span class="err">q_{\theta</span><span class="p">}</span><span class="err">\</span><span class="nt">left</span><span class="o">(</span><span class="nt">y_</span><span class="p">{</span><span class="err">t</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">mid</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">&lt;t</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">x</span><span class="p">}</span><span class="err">\</span><span class="nt">right</span><span class="o">)</span><span class="err">}</span><span class="p">{</span><span class="err">p\left(y_{t</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">mid</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">y</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">&lt;t</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">x</span><span class="p">}</span><span class="err">\</span><span class="nt">right</span><span class="o">)</span><span class="err">}</span><span class="w"> </span><span class="err">\</span><span class="nt">quad</span><span class="w"> </span><span class="err">\</span><span class="nt">triangleright</span><span class="err">\</span><span class="o">)</span><span class="w"> </span><span class="nt">Eq</span><span class="o">.</span><span class="w"> </span><span class="nt">5</span><span class="o">,</span><span class="w"> </span><span class="nt">Eq</span><span class="o">.</span><span class="w"> </span><span class="nt">6</span>
<span class="w">        </span><span class="nt">Compute</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">gradient</span><span class="w"> </span><span class="nt">of</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">language</span><span class="w"> </span><span class="nt">modeling</span><span class="w"> </span><span class="nt">loss</span><span class="o">:</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">nabla</span><span class="w"> </span><span class="err">\</span><span class="nt">mathcal</span><span class="p">{</span><span class="err">L</span><span class="p">}</span><span class="nt">_</span><span class="p">{</span><span class="err">\mathrm{PT</span><span class="p">}</span><span class="err">}</span><span class="o">=</span><span class="nt">-</span><span class="err">\</span><span class="nt">frac</span><span class="p">{</span><span class="err">1</span><span class="p">}{</span><span class="err">M</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">sum_</span><span class="p">{</span><span class="err">\boldsymbol{d</span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="nt">in</span><span class="w"> </span><span class="nt">D_</span><span class="p">{</span><span class="err">\mathrm{PT</span><span class="p">}</span><span class="err">}</span><span class="o">^</span><span class="p">{</span><span class="err">c</span><span class="p">}</span><span class="err">}</span><span class="w"> </span><span class="err">\</span><span class="nt">nabla</span><span class="w"> </span><span class="err">\</span><span class="nt">log</span><span class="w"> </span><span class="nt">q_</span><span class="p">{</span><span class="err">\theta</span><span class="p">}</span><span class="o">(</span><span class="err">\</span><span class="nt">boldsymbol</span><span class="p">{</span><span class="err">d</span><span class="p">}</span><span class="o">)</span><span class="err">\</span><span class="o">)</span>
<span class="w">        </span><span class="nt">Update</span><span class="w"> </span><span class="nt">model</span><span class="w"> </span><span class="nt">parameters</span><span class="o">:</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="err">\</span><span class="nt">theta</span><span class="w"> </span><span class="err">\</span><span class="nt">leftarrow</span><span class="w"> </span><span class="err">\</span><span class="nt">theta-</span><span class="err">\</span><span class="nt">eta</span><span class="err">\</span><span class="nt">left</span><span class="cp">[</span><span class="p">(</span><span class="o">\</span><span class="nx">nabla</span><span class="w"> </span><span class="o">\</span><span class="nx">mathcal</span><span class="p">{</span><span class="nx">L</span><span class="p">})</span><span class="nx">_</span><span class="p">{</span><span class="o">\</span><span class="nx">text</span><span class="w"> </span><span class="p">{</span><span class="nx">Single</span><span class="w"> </span><span class="p">}}</span><span class="o">+</span><span class="p">(</span><span class="o">\</span><span class="nx">nabla</span><span class="w"> </span><span class="o">\</span><span class="nx">mathcal</span><span class="p">{</span><span class="nx">L</span><span class="p">})</span><span class="nx">_</span><span class="p">{</span><span class="o">\</span><span class="nx">text</span><span class="w"> </span><span class="p">{</span><span class="nx">Long</span><span class="w"> </span><span class="p">}}^{</span><span class="o">\</span><span class="nx">text</span><span class="w"> </span><span class="p">{</span><span class="nx">Norm</span><span class="w"> </span><span class="p">}}</span><span class="o">+\</span><span class="nx">nabla</span><span class="w"> </span><span class="o">\</span><span class="nx">mathcal</span><span class="p">{</span><span class="nx">L</span><span class="p">}</span><span class="nx">_</span><span class="p">{</span><span class="o">\</span><span class="nx">mathrm</span><span class="p">{</span><span class="nx">PT</span><span class="p">}}</span><span class="o">\</span><span class="nx">right</span><span class="cp">]</span><span class="err">\</span><span class="o">)</span>
<span class="nt">until</span><span class="w"> </span><span class="nt">converge</span><span class="w"> </span><span class="nt">and</span><span class="w"> </span><span class="nt">return</span><span class="w"> </span><span class="err">\</span><span class="o">(</span><span class="nt">q_</span><span class="p">{</span><span class="err">\theta</span><span class="p">}</span><span class="err">\</span><span class="o">)</span>
</code></pre></div>

<h1>3 Experiments</h1>
<h3>3.1 Experimental Setup</h3>
<p>We take instruction-following [OWJ+22] as the conditional text generation task, where models are trained to generate responses according to the instructions. We fine-tune a large model on the dataset $\mathcal{D}$ consisting of instruction-response pairs as the teacher model. Then, we compare different KD methods on $\mathcal{D}$ by evaluating the student model's instruction-following performance.</p>
<p>Base Models Our student models come from three model families with various sizes: GPT2 [RWC+19] (120M, 340M, 760M), OPT [ZRG+22] (1.3B, 2.7B, 6.7B), and LLaMA [TLI+23] (7B). For teacher models of each model family, we use GPT-2-1.5B, OPT-13B, and LLaMA-13B respectively. These models are fine-tuned on $\mathcal{D}$ in advance. We also present the results using GPTJ [WK21] as the teacher model in Appendix C.1.</p>
<p>Training We construct the training data from databricks-dolly-15K ${ }^{4}$ consisting of 15 K human-written instruction-response pairs. We filter out samples that exceed the context length of the models. Then, we randomly split 1 K and 0.5 K samples for validation and testing, respectively, leaving about 12.5 K examples for training. For $\mathcal{D}_{\mathrm{PT}}$, we use OpenWebText [GCPT19] for the GPT-2 family and the RoBERTa training corpus [LOG+19] for other models. We set the teacher-mix-in strength $\alpha=0.2$ throughout the experiments in Eq. 4. We use Rouge-L [Lin04] scores on the validation set to search for hyper-parameters because it aligns better with human preference than validation losses [WMA+22]. More details are shown in Appendix B.1.</p>
<p>Evaluation We evaluate the trained models on five instruction-following datasets:</p>
<ul>
<li>DollyEval: the 500-sample test set we split from the databricks-dolly-15k dataset.</li>
<li>SelfInst [WKM+23]: A user-oriented instruction-following set with 252 samples.</li>
<li>VicunaEval [CLL+23]: The 80 challenging questions used in the Vicuna evaluation.</li>
<li>S-NI: The test set of SUPER-NATURALInStruCtions [WMA+22] consisting of 9K samples ranging from 119 tasks. Following [PLH+23], we split the set into 3 subsets whose ground truth</li>
</ul>
<p><sup id="fnref2:0"><a class="footnote-ref" href="#fn:0">1</a></sup></p>
<p>response lengths lie in $[0,5],[6,10]$, and $[11,+\infty]$. We use the $[11,+\infty]$ subset in Section 3.2 and conduct an analysis on all subsets in Section 3.3.</p>
<ul>
<li>UnNI: We randomly sample 10K samples from the core set of UnnaturalInstructions [HSLS23] for evaluation. Similar to S-NI, we first conduct the evaluations on the $[11,+\infty]$ subset, followed by an analysis of the performance on all subsets in Appendix C.3.
We adopt three metrics to evaluate the model-generated responses:</li>
<li>R-L: The Rouge-L [Lin04] score to measure the precision of the model generation. [WMA+22] has shown that Rouge-L is suitable for large-scale instruction-following evaluation.</li>
<li>GPT4: The GPT-4 feedback [ZCS+23] by asking GPT-4 to compare model-generated responses with the ground truth answers ${ }^{3}$ and raise 1-10 scores for both responses (see Appendix B. 2 for the prompt we use). We report the ratio of the total score of model responses and ground truth answers. This metric is only applied to DollyEval, SelfInst, and VicunaEval.</li>
<li>Human Evaluation: We conduct human evaluations on the SelfInst dataset following [PLH+23] by asking volunteers to compare two responses produced by different models and annotate "Win", "Tie", or "Loss". More human evaluation details can be found in Appendix B.3.
For all test sets, we sample the responses with the temperature $=1$ and report the average scores of 5 generations for each prompt with different random seeds.</li>
</ul>
<p>Baselines We consider three baselines in our main experiment:</p>
<ul>
<li>SFT w/o KD directly fine-tunes the student model on $\mathcal{D}$ supervised by the golden responses.</li>
<li>KD [SDCW19, SST+20] fine-tunes the student model on $\mathcal{D}$ using the teacher distribution as the supervision at each token step, also known as word-level KD.</li>
<li>SeqKD [KR16, CLL+23, TGZ+23, PLH+23, ZLX+23] fine-tunes the student model on the data generated by the teacher model.</li>
</ul>
<h1>3.2 Results</h1>
<p>We present the R-L and GPT4 evaluation results in Table 1, from which we have three observations.
First, by comparing the overall performance of MinILLM with the baselines, we observe that the model distilled by our KD method outperforms the baselines in almost all cases, when trained with different base models, tested on various evaluation sets, and scored by both Rouge-L and GPT-4 feedback. This verifies the good generalization and high overall performance of our KD method. We also find that MiniLLM generally works much better on datasets other than Dolly compared with the baselines, indicating its good out-of-distribution generalization.</p>
<p>Second, the Rouge-L scores show that MiniLLM produces the most precise responses that have high overlaps with the ground-truth responses. In some cases, especially on Vicuna, S-NI, and UnNI, student models reach even higher Rouge-L scores than the teacher models, which matches the observation in [FLT+18]. We conjecture that the standard teacher-forcing fine-tuning on $\mathcal{D}$ brings training-inference discrepancy to the teacher model, also known as exposure bias [BVJS15]. On the contrary, MiniLLM is optimized with policy optimization methods, which samples responses from student models during training and thus alleviates exposure bias [PH21]. We include further analysis on exposure bias in Section 3.3.</p>
<p>Third, comparing the results across model sizes and model families, we can see that the improvement of MiniLLM is consistent when the base model sizes vary from 120 M to 13B across three model families. This tendency is also illustrated in Figure 1, which demonstrates the excellent scalability and generalization of our method in the era of LLMs.</p>
<p>The human evaluation results on the SelfInst dataset based on the LLaMA family are shown in Figure 4. MiniLLM obtains better human preference than all the baselines, performing comparably to the teacher model.
<img alt="img-2.jpeg" src="img-2.jpeg" /></p>
<p>Figure 4: Human evaluation results. We use LLaMA-7B as the student and LLaMA-13B as the teacher.</p>
<p><sup id="fnref3:0"><a class="footnote-ref" href="#fn:0">1</a></sup></p>
<table>
<thead>
<tr>
<th style="text-align: center;">Model</th>
<th style="text-align: center;">#Params</th>
<th style="text-align: center;">Method</th>
<th style="text-align: center;">DollyEval GPT4</th>
<th style="text-align: center;"></th>
<th style="text-align: center;">SelfInst R-L</th>
<th style="text-align: center;"></th>
<th style="text-align: center;">VicunaEval GPT4</th>
<th style="text-align: center;"></th>
<th style="text-align: center;">S-NI R-L</th>
<th style="text-align: center;">UnNI R-L</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">GPT-2</td>
<td style="text-align: center;">1.5B</td>
<td style="text-align: center;">Teacher</td>
<td style="text-align: center;">58.4</td>
<td style="text-align: center;">27.6</td>
<td style="text-align: center;">42.9</td>
<td style="text-align: center;">14.3</td>
<td style="text-align: center;">48.6</td>
<td style="text-align: center;">16.3</td>
<td style="text-align: center;">27.6</td>
<td style="text-align: center;">31.8</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;">120M</td>
<td style="text-align: center;">SFT w/o KD</td>
<td style="text-align: center;">38.6</td>
<td style="text-align: center;">23.3</td>
<td style="text-align: center;">26.3</td>
<td style="text-align: center;">10.0</td>
<td style="text-align: center;">32.8</td>
<td style="text-align: center;">14.7</td>
<td style="text-align: center;">16.3</td>
<td style="text-align: center;">18.5</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">KD</td>
<td style="text-align: center;">40.3</td>
<td style="text-align: center;">22.8</td>
<td style="text-align: center;">27.8</td>
<td style="text-align: center;">10.8</td>
<td style="text-align: center;">31.9</td>
<td style="text-align: center;">13.4</td>
<td style="text-align: center;">19.7</td>
<td style="text-align: center;">22.0</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SeqKD</td>
<td style="text-align: center;">41.2</td>
<td style="text-align: center;">22.7</td>
<td style="text-align: center;">26.2</td>
<td style="text-align: center;">10.1</td>
<td style="text-align: center;">31.0</td>
<td style="text-align: center;">14.3</td>
<td style="text-align: center;">16.4</td>
<td style="text-align: center;">18.8</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MinILLM</td>
<td style="text-align: center;">44.7</td>
<td style="text-align: center;">24.6</td>
<td style="text-align: center;">29.2</td>
<td style="text-align: center;">13.2</td>
<td style="text-align: center;">34.1</td>
<td style="text-align: center;">16.9*</td>
<td style="text-align: center;">25.3</td>
<td style="text-align: center;">26.6</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;">340M</td>
<td style="text-align: center;">SFT w/o KD</td>
<td style="text-align: center;">51.9</td>
<td style="text-align: center;">25.5</td>
<td style="text-align: center;">39.6</td>
<td style="text-align: center;">13.0</td>
<td style="text-align: center;">42.3</td>
<td style="text-align: center;">16.0</td>
<td style="text-align: center;">25.1</td>
<td style="text-align: center;">32.0</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">KD</td>
<td style="text-align: center;">51.6</td>
<td style="text-align: center;">25.0</td>
<td style="text-align: center;">39.2</td>
<td style="text-align: center;">12.0</td>
<td style="text-align: center;">42.8</td>
<td style="text-align: center;">15.4</td>
<td style="text-align: center;">23.7</td>
<td style="text-align: center;">31.0</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SeqKD</td>
<td style="text-align: center;">50.5</td>
<td style="text-align: center;">25.3</td>
<td style="text-align: center;">39.0</td>
<td style="text-align: center;">12.6</td>
<td style="text-align: center;">43.0</td>
<td style="text-align: center;">16.9*</td>
<td style="text-align: center;">22.9</td>
<td style="text-align: center;">30.2</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MinILLM</td>
<td style="text-align: center;">52.2</td>
<td style="text-align: center;">25.4</td>
<td style="text-align: center;">40.5</td>
<td style="text-align: center;">15.6</td>
<td style="text-align: center;">42.6</td>
<td style="text-align: center;">17.7*</td>
<td style="text-align: center;">27.4</td>
<td style="text-align: center;">34.5</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;">760M</td>
<td style="text-align: center;">SFT w/o KD</td>
<td style="text-align: center;">50.7</td>
<td style="text-align: center;">25.4</td>
<td style="text-align: center;">38.3</td>
<td style="text-align: center;">12.4</td>
<td style="text-align: center;">43.1</td>
<td style="text-align: center;">16.1</td>
<td style="text-align: center;">21.5</td>
<td style="text-align: center;">27.1</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">KD</td>
<td style="text-align: center;">53.4</td>
<td style="text-align: center;">25.9</td>
<td style="text-align: center;">40.4</td>
<td style="text-align: center;">13.4</td>
<td style="text-align: center;">43.4</td>
<td style="text-align: center;">16.9*</td>
<td style="text-align: center;">25.3</td>
<td style="text-align: center;">31.7</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SeqKD</td>
<td style="text-align: center;">52.0</td>
<td style="text-align: center;">25.6</td>
<td style="text-align: center;">38.9</td>
<td style="text-align: center;">14.0</td>
<td style="text-align: center;">42.4</td>
<td style="text-align: center;">15.9</td>
<td style="text-align: center;">26.1</td>
<td style="text-align: center;">32.9</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MinILLM</td>
<td style="text-align: center;">54.7</td>
<td style="text-align: center;">26.4</td>
<td style="text-align: center;">44.6*</td>
<td style="text-align: center;">15.9</td>
<td style="text-align: center;">45.7</td>
<td style="text-align: center;">18.3*</td>
<td style="text-align: center;">29.3*</td>
<td style="text-align: center;">37.7*</td>
</tr>
<tr>
<td style="text-align: center;">OPT</td>
<td style="text-align: center;">13B</td>
<td style="text-align: center;">Teacher</td>
<td style="text-align: center;">70.3</td>
<td style="text-align: center;">29.2</td>
<td style="text-align: center;">56.1</td>
<td style="text-align: center;">18.4</td>
<td style="text-align: center;">58.0</td>
<td style="text-align: center;">17.8</td>
<td style="text-align: center;">30.4</td>
<td style="text-align: center;">36.1</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;">1.3B</td>
<td style="text-align: center;">SFT w/o KD</td>
<td style="text-align: center;">52.6</td>
<td style="text-align: center;">26.0</td>
<td style="text-align: center;">37.7</td>
<td style="text-align: center;">11.4</td>
<td style="text-align: center;">40.5</td>
<td style="text-align: center;">15.6</td>
<td style="text-align: center;">23.1</td>
<td style="text-align: center;">28.4</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">KD</td>
<td style="text-align: center;">52.7</td>
<td style="text-align: center;">25.4</td>
<td style="text-align: center;">36.0</td>
<td style="text-align: center;">12.2</td>
<td style="text-align: center;">40.8</td>
<td style="text-align: center;">14.9</td>
<td style="text-align: center;">21.9</td>
<td style="text-align: center;">27.0</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SeqKD</td>
<td style="text-align: center;">51.0</td>
<td style="text-align: center;">26.1</td>
<td style="text-align: center;">36.6</td>
<td style="text-align: center;">12.7</td>
<td style="text-align: center;">42.6</td>
<td style="text-align: center;">16.6</td>
<td style="text-align: center;">21.4</td>
<td style="text-align: center;">28.2</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MinILLM</td>
<td style="text-align: center;">60.7</td>
<td style="text-align: center;">26.7</td>
<td style="text-align: center;">47.0</td>
<td style="text-align: center;">14.8</td>
<td style="text-align: center;">50.6</td>
<td style="text-align: center;">17.9*</td>
<td style="text-align: center;">28.6</td>
<td style="text-align: center;">33.4</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;">2.7B</td>
<td style="text-align: center;">SFT w/o KD</td>
<td style="text-align: center;">55.4</td>
<td style="text-align: center;">27.1</td>
<td style="text-align: center;">38.9</td>
<td style="text-align: center;">13.9</td>
<td style="text-align: center;">44.8</td>
<td style="text-align: center;">16.6</td>
<td style="text-align: center;">24.9</td>
<td style="text-align: center;">32.3</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">KD</td>
<td style="text-align: center;">60.5</td>
<td style="text-align: center;">25.9</td>
<td style="text-align: center;">48.6</td>
<td style="text-align: center;">13.8</td>
<td style="text-align: center;">51.3</td>
<td style="text-align: center;">16.7</td>
<td style="text-align: center;">26.3</td>
<td style="text-align: center;">30.2</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SeqKD</td>
<td style="text-align: center;">57.6</td>
<td style="text-align: center;">27.5</td>
<td style="text-align: center;">40.5</td>
<td style="text-align: center;">13.3</td>
<td style="text-align: center;">44.5</td>
<td style="text-align: center;">16.5</td>
<td style="text-align: center;">25.3</td>
<td style="text-align: center;">32.3</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MinILLM</td>
<td style="text-align: center;">63.2</td>
<td style="text-align: center;">27.4</td>
<td style="text-align: center;">52.7</td>
<td style="text-align: center;">17.2</td>
<td style="text-align: center;">55.9</td>
<td style="text-align: center;">19.1*</td>
<td style="text-align: center;">30.7*</td>
<td style="text-align: center;">35.1</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;">6.7B</td>
<td style="text-align: center;">SFT w/o KD</td>
<td style="text-align: center;">67.9</td>
<td style="text-align: center;">27.6</td>
<td style="text-align: center;">56.4</td>
<td style="text-align: center;">16.4</td>
<td style="text-align: center;">57.3</td>
<td style="text-align: center;">17.8</td>
<td style="text-align: center;">30.3</td>
<td style="text-align: center;">28.6</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">KD</td>
<td style="text-align: center;">68.6</td>
<td style="text-align: center;">28.3</td>
<td style="text-align: center;">58.0</td>
<td style="text-align: center;">17.0</td>
<td style="text-align: center;">57.0</td>
<td style="text-align: center;">17.5</td>
<td style="text-align: center;">30.7*</td>
<td style="text-align: center;">26.7</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SeqKD</td>
<td style="text-align: center;">69.6</td>
<td style="text-align: center;">28.5</td>
<td style="text-align: center;">54.0</td>
<td style="text-align: center;">17.0</td>
<td style="text-align: center;">57.6</td>
<td style="text-align: center;">17.9*</td>
<td style="text-align: center;">30.4</td>
<td style="text-align: center;">28.2</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MinILLM</td>
<td style="text-align: center;">70.8*</td>
<td style="text-align: center;">29.0</td>
<td style="text-align: center;">58.5*</td>
<td style="text-align: center;">17.5</td>
<td style="text-align: center;">60.1*</td>
<td style="text-align: center;">18.7*</td>
<td style="text-align: center;">32.5*</td>
<td style="text-align: center;">36.7*</td>
</tr>
<tr>
<td style="text-align: center;">LLaMA</td>
<td style="text-align: center;">13B</td>
<td style="text-align: center;">Teacher</td>
<td style="text-align: center;">79.0</td>
<td style="text-align: center;">29.7</td>
<td style="text-align: center;">75.5</td>
<td style="text-align: center;">23.4</td>
<td style="text-align: center;">65.1</td>
<td style="text-align: center;">19.4</td>
<td style="text-align: center;">35.8</td>
<td style="text-align: center;">38.5</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;">7B</td>
<td style="text-align: center;">SFT w/o KD</td>
<td style="text-align: center;">73.0</td>
<td style="text-align: center;">26.3</td>
<td style="text-align: center;">69.2</td>
<td style="text-align: center;">20.8</td>
<td style="text-align: center;">61.6</td>
<td style="text-align: center;">17.5</td>
<td style="text-align: center;">32.4</td>
<td style="text-align: center;">35.8</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">KD</td>
<td style="text-align: center;">73.7</td>
<td style="text-align: center;">27.4</td>
<td style="text-align: center;">70.5</td>
<td style="text-align: center;">20.2</td>
<td style="text-align: center;">62.7</td>
<td style="text-align: center;">18.4</td>
<td style="text-align: center;">33.7</td>
<td style="text-align: center;">37.9</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">SeqKD</td>
<td style="text-align: center;">73.6</td>
<td style="text-align: center;">27.5</td>
<td style="text-align: center;">71.5</td>
<td style="text-align: center;">20.8</td>
<td style="text-align: center;">62.6</td>
<td style="text-align: center;">18.1</td>
<td style="text-align: center;">33.7</td>
<td style="text-align: center;">37.6</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">MinILLM</td>
<td style="text-align: center;">76.4</td>
<td style="text-align: center;">29.0</td>
<td style="text-align: center;">73.1</td>
<td style="text-align: center;">23.2</td>
<td style="text-align: center;">64.1</td>
<td style="text-align: center;">20.7*</td>
<td style="text-align: center;">35.5</td>
<td style="text-align: center;">40.2*</td>
</tr>
</tbody>
</table>
<p>Table 1: Evaluation results. GPT4 and R-L stand for the average GPT-4 feedback scores and RougeL scores across 5 random seeds, respectively. The best scores of each model size are boldfaced, and the scores where the student model outperforms the teacher are marked with *.</p>
<h1>3.3 Analysis</h1>
<p>Scaling Law of Teacher Although it is intuitive that we can distill better student models from larger teacher models, [MFL+20] has shown that increasing the teacher models' sizes does not guarantee the improvement of student models, sometimes even harming the distillation performance. It is not clear how MinILLM works when we scale up the teacher models' sizes. Therefore, we compare MinILLM and SeqKD using teacher models with different sizes and fix the size of the student model. We present the results based on the GPT-2 family in Figure 5 and that based on the OPT family in Appendix C.2. We can see that MinILLM constantly outperforms SeqKD, and the student model performance is positively correlated with the teacher model sizes. This shows the potential of our method to compress models with massive parameters.
<img alt="img-3.jpeg" src="img-3.jpeg" /></p>
<p>Figure 5: The scaling law of teacher based on the GPT-2 family models. We compare MinILLM and SeqKD with GPT-2-125M as the student and GPT-2 340M, 760M, and 1.5B as teachers.</p>
<p><img alt="img-4.jpeg" src="img-4.jpeg" /></p>
<p>Figure 6: The excess error caused by the training-decoding discrepancy (ExAccErr) accumulated with the generation length. Lower ExAccErr means the method introduces less exposure bias.</p>
<p><img alt="img-5.jpeg" src="img-5.jpeg" /></p>
<p>Figure 7: The Rouge-L scores of the distilled models against SFT on the different subsets of S-NI split by the golden responses' length.</p>
<table>
<thead>
<tr>
<th></th>
<th>SST2</th>
<th></th>
<th>BoolQ</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Teacher</td>
<td>0.025</td>
<td>93.0</td>
<td>0.356</td>
<td>74.5</td>
</tr>
<tr>
<td>KD</td>
<td>0.191</td>
<td>84.7</td>
<td>0.682</td>
<td>63.5</td>
</tr>
<tr>
<td>SeqKD</td>
<td>0.243</td>
<td>66.5</td>
<td>0.681</td>
<td>62.8</td>
</tr>
<tr>
<td>MiniLLM</td>
<td>0.099</td>
<td>89.7</td>
<td>0.502</td>
<td>67.8</td>
</tr>
</tbody>
</table>
<p>Table 2: The ECE and accuracy scores on SST2 and BoolQ datasets. The best scores among student models are <strong>boldfaced</strong>.</p>
<table>
<thead>
<tr>
<th></th>
<th>DollyEval</th>
<th></th>
<th>SelfInst</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Teacher</td>
<td>Dist-4</td>
<td>Loss</td>
<td>Dist-4</td>
<td>Loss</td>
</tr>
<tr>
<td>SFT</td>
<td>99.3</td>
<td>3.55</td>
<td>99.1</td>
<td>4.44</td>
</tr>
<tr>
<td>MiniLLM</td>
<td>99.5</td>
<td>3.89</td>
<td>99.0</td>
<td>5.28</td>
</tr>
<tr>
<td>MiniLLM</td>
<td>99.0</td>
<td>3.95</td>
<td>98.6</td>
<td>5.33</td>
</tr>
</tbody>
</table>
<p>Table 3: The distinct 4-grams (Dist-4) and language modeling loss (Loss) on the test sets based on the LLaMA family. MiniLLM preserves generation diversity.</p>
<p><strong>Exposure Bias</strong> Language generation models trained to minimize <em>forward</em> KLD suffer from exposure bias [BVJS15] caused by the discrepancy between teacher-forcing training and free-run generation. When training MiniLLM, the student model sees samples generated by itself, alleviating the training-inference mismatch [PH21]. In Figure 6, we use the ExAccErr metric [AEABC22] defined in Appendix B.5 to measure the excess accumulated error due to exposure bias. The experiment is based on GPT-2-125M, with GPT-2-1.5B as the teacher, using Dolly as the test set. For each prompt, we sample 10 responses to reduce the variance. We can see that the ExAccErrs of the baselines continuously grow during generation, while MiniLLM has a much lower ExAccErr, and the error stops accumulating in long-text generation (&gt; 150 tokens).</p>
<p><strong>Calibration</strong> [Ope23] has shown that models trained with policy optimization are likely to be poorly calibrated. We test the calibration of MiniLLM and the KD baselines on two widely-used text classification datasets: SST2 [SPW+13] and BoolQ [CLC+19], based on LLaMA-7B. We design zero-shot classification instructions (see Appendix B.2) and take the probability of the label words to compute the ECE scores [NDZ+19]. From Table 2, we observe that KD and SeqKD models are worse calibrated than the teacher model, which potentially explains their low performance on canonical benchmarks [GWS+23]. We suspect that minimizing <em>forward</em> KLD causes the models to push high probabilities to void regions of the target distribution, which leads to significant distribution differences between the student and the teacher (see the example in Figure 2). In contrast, MiniLLM focuses on accurately learning the major parts of the target distribution and narrows the ECE scores gap between the student and the teacher.</p>
<p><strong>Performance on Different Response Length</strong> We study the models' performance when the golden response lengths belong to different ranges. In Figure 7, we illustrate the Rouge-L scores of different KD models against the SFT models on three S-NI subsets split by the length of the ground truth responses. We can see that all methods achieve low scores on prompts that expect short responses (≤ 5 tokens), probably because most responses in our training set are long sentences, introducing a distribution shift between training and evaluation [PLH+23]. Furthermore, the output spaces of these prompts are relatively small, allowing the student model to cover most modes of the teacher, and thus <em>reverse</em> KLD and <em>forward</em> KLD have similar performance. For prompts with longer responses (≥ 6 tokens), the teacher distribution contains more modes than the students due to the complex out-</p>
<table>
<thead>
<tr>
<th style="text-align: left;"></th>
<th style="text-align: right;">Valid.</th>
<th style="text-align: right;">Dolly</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: right;">R-L</td>
<td style="text-align: right;">R-L</td>
</tr>
<tr>
<td style="text-align: left;">MINILLM</td>
<td style="text-align: right;">$\mathbf{2 7 . 4}$</td>
<td style="text-align: right;">$\mathbf{2 4 . 6}$</td>
</tr>
<tr>
<td style="text-align: left;">w/o Length Norm.</td>
<td style="text-align: right;">17.4</td>
<td style="text-align: right;">14.7</td>
</tr>
<tr>
<td style="text-align: left;">w/o Teacher-Mixed</td>
<td style="text-align: right;">22.3</td>
<td style="text-align: right;">20.4</td>
</tr>
<tr>
<td style="text-align: left;">w/o Single-Step</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">23.7</td>
</tr>
</tbody>
</table>
<p>Table 4: The performance on the validation and test set when different combinations of MinILLM optimization strategies are applied.
<img alt="img-6.jpeg" src="img-6.jpeg" /></p>
<p>Figure 8: The reverse KLD between the teacher and the students during MinILLM training when different optimization strategies are applied.
put spaces, which shows the advantage of MinILLM against standard KD models. Similar results on UnNI are shown in Appendix C.3.</p>
<p>Generation Diversity [ $\left.\mathrm{CCF}^{+}\right 20]$ has found that the model optimized by minimizing reverse KLD is likely to lose modes, which affects the generation diversity. We follow [PH21] to discuss generation diversity from three aspects: (i) generating multiple distinct responses given a prompt. (ii) generating linguistically complex responses. (iii) the ability to generate contents that have high coverage of the real data distribution. For (i), we argue that for many NLP applications, generating one correct response is sufficient, especially for those scenarios demanding high truthfulness and reliability [JLF+23]. For (ii) and (iii), we report the responses' distinct 4 -gram proportion and the language modeling loss on the test sets in Table 3, using the base models from the LLaMA family (see Appendix B. 4 for more details) . We can see that MinILLM preserves the distinct 4 -gram proportion in the generated responses and language modeling loss on the test set.</p>
<h1>3.4 Ablation Studies on Optimization Strategies</h1>
<p>We evaluate the effectiveness of the three strategies proposed to stabilize and accelerate optimization in Section 2.2 by distilling a GPT-2-125M model from the GPT-2-1.5B model. More ablation studies can be found in Appendix C.4. In Table 4, we report the best Rouge-L scores on the validation set of each run and the evaluation results of the corresponding checkpoints. We also plot the reverse KLD between the student and the teacher during training in Figure 8, where the curves are smoothed by 32 steps. We can see that Teacher-Mixed Sampling and Length Normalization works for stabilizing training. Although the reverse KLDs also decrease without these strategies, we find that the models quickly learn to generate repeated, short, or meaningless strings that have high probabilities in the teacher distribution (see examples in Appendix D), which is known as reward hacking [SHKK22]. This also leads to the low generation performance in Table 4. From Figure 8, we also observe that the Single-Step Decomposition effectively reduces the variance of the training process, which also results in higher scores on the validation and test sets.</p>
<h2>4 Related Work</h2>
<p>Large Language Models Large language models (LLMs; BMR ${ }^{+} 20$, TDFH $^{+}$22, $\mathrm{CND}^{+}$22, Ope23, ADF +23 ) have shown superior performance by solving various NLP tasks in a generative manner. Recent works apply instruction tuning [WBZ+22, SWR+22, CHL+22] or learning from human feedback [OWJ+22, BJN+22] to improve the alignment of LLMs with humans further and create general AI assistants [Ope22, Goo23]. There are also efforts to build open-source LLMs [ZRG+22, TLI+23, BSA+23] to facilitate research and industry development. Although appealing, the broad capacities of LLMs usually emerge with large model sizes [ $\mathrm{KMH}^{+}$20, WTB ${ }^{+}$22] that require massive computational resources. Therefore, model compression is critical for the practical deployment and further research of LLMs.</p>
<p>Knowledge Distillation Knowledge distillation (KD; HVD15), as a widely used model compression technique, aims at training a student model with the guidance of a teacher model [ $\mathrm{RCG}^{+}$15, SDCW19, JBMD21]. In the NLP community, many works apply KD to text classification tasks by mimicking the teacher model's output distribution [SST+20, LHS+21, ZSL+23], hid-</p>
<p>den states [JYS+20, SCGL19], or attention scores [WWD+20, WBH+21]. For text generation, the standard KD method is to approximately minimize the forward KLD between the student's and the teacher's generation distribution by using the teacher's output at each time step as supervision [SDCW19] or direct training on the teacher's generated texts [KR16, TGZ+23, CLL+23, PLH+23]. In this paper, we minimize the reverse KLD, which is more suitable for LLMs when the teacher distribution is available. Concurrent works [AVS+23, WLDM23] also explore more the distribution discrepancy metrics in KD.</p>
<p>Distribution Discrepancy Metrics in Text Generation The distribution discrepancy metrics play a significant role in training text generation models. The forward KLD is widely used due to its simplicity when derived as the Maximum Likelihood Estimate (MLE) objective [ZZ19]. However, previous works show that minimizing forward KLD leads to zero-forcing behavior where models try to cover all modes of the target distribution and sacrifice the accuracy of major modes [Hus15]. Some works resort to using other metrics to remedy this problem, such as reverse KLD [JHC+20], Total Variation Distance [JKH+23], and Optimal Transport [LLW+20]. Our paper tackles this problem under the scenario of knowledge distillation for LLMs.</p>
<h1>5 Conclusion</h1>
<p>In this work, we investigate the problem of distilling the knowledge of LLMs into small language models. We find that the standard distillation methods minimizing the forward KLD is sub-optimal in language generation scenarios because the teacher's output distribution contains more modes than the student's, and forward KLD forces the student distribution to overestimate the low-probability regions of the teacher distribution. Therefore, we propose MinILLM that minimizes the reverse KLD between the teacher and student distribution and design an algorithm to optimize this objective. Extensive experiments show that MinILLM produce more precise responses that have higher overall quality than standard KD models. We also find that MinILLM has lower exposure bias, better calibration, and higher performance in long-text generation with good generation diversity.</p>
<h2>Acknowledgements</h2>
<p>This work was supported by the National Key Research and Development Program of China (No. 2021ZD0113304), the National Science Foundation for Distinguished Young Scholars (with No. 62125604), and the NSFC projects (Key project with No. 61936010).</p>
<h2>References</h2>
<p>[ADF ${ }^{+}$23] Rohan Anil, Andrew M Dai, Orhan Firat, Melvin Johnson, Dmitry Lepikhin, Alexandre Passos, Siamak Shakeri, Emanuel Taropa, Paige Bailey, Zhifeng Chen, et al. Palm 2 technical report. arXiv preprint arXiv:2305.10403, 2023.
[AEABC22] Kushal Arora, Layla El Asri, Hareesh Bahuleyan, and Jackie Cheung. Why exposure bias matters: An imitation learning perspective of error accumulation in language generation. In Findings of ACL, 2022.
[AVS ${ }^{+}$23] Rishabh Agarwal, Nino Vieillard, Piotr Stanczyk, Sabela Ramos, Matthieu Geist, and Olivier Bachem. GKD: Generalized knowledge distillation for auto-regressive sequence models. arXiv preprint arXiv:2306.13649, 2023.
[BHA ${ }^{+}$21] Rishi Bommasani, Drew A Hudson, Ehsan Adeli, Russ Altman, Simran Arora, Sydney von Arx, Michael S Bernstein, Jeannette Bohg, Antoine Bosselut, Emma Brunskill, et al. On the opportunities and risks of foundation models. arXiv preprint arXiv:2108.07258, 2021.
[BJN ${ }^{+}$22] Yuntao Bai, Andy Jones, Kamal Ndousse, Amanda Askell, Anna Chen, Nova DasSarma, Dawn Drain, Stanislav Fort, Deep Ganguli, Tom Henighan, et al. Training a helpful and harmless assistant with reinforcement learning from human feedback. arXiv preprint arXiv:2204.05862, 2022.</p>
<p>[BLW ${ }^{+}$21] Sid Black, Gao Leo, Phil Wang, Connor Leahy, and Stella Biderman. GPT-Neo: Large Scale Autoregressive Language Modeling with Mesh-Tensorflow, March 2021.
[BMR ${ }^{+}$20] Tom Brown, Benjamin Mann, Nick Ryder, Melanie Subbiah, et al. Language models are few-shot learners. In Proceedings of NeurIPS, 2020.
[BSA ${ }^{+}$23] Stella Biderman, Hailey Schoelkopf, Quentin Anthony, Herbie Bradley, Kyle O'Brien, Eric Hallahan, Mohammad Aflah Khan, Shivanshu Purohit, USVSN Sai Prashanth, Edward Raff, et al. Pythia: A suite for analyzing large language models across training and scaling. arXiv preprint arXiv:2304.01373, 2023.
[BVJS15] Samy Bengio, Oriol Vinyals, Navdeep Jaitly, and Noam Shazeer. Scheduled sampling for sequence prediction with recurrent neural networks. In Proceedings of NeurIPS, 2015.
[CCF ${ }^{+}$20] Massimo Caccia, Lucas Caccia, William Fedus, Hugo Larochelle, Joelle Pineau, and Laurent Charlin. Language gans falling short. In ICLR, 2020.
[CDP ${ }^{+}$18] Liqun Chen, Shuyang Dai, Yunchen Pu, Erjin Zhou, Chunyuan Li, Qinliang Su, Changyou Chen, and Lawrence Carin. Symmetric variational autoencoder and connections to adversarial learning. In Proceedings of AISTATS, 2018.
[CHL ${ }^{+}$22] Hyung Won Chung, Le Hou, Shayne Longpre, Barret Zoph, Yi Tay, William Fedus, Eric Li, Xuezhi Wang, Mostafa Dehghani, Siddhartha Brahma, et al. Scaling instruction-finetuned language models. arXiv preprint arXiv:2210.11416, 2022.
[Cio21] Kamil Ciosek. Imitation learning by reinforcement learning. In ICLR, 2021.
[CLC ${ }^{+}$19] Christopher Clark, Kenton Lee, Ming-Wei Chang, Tom Kwiatkowski, Michael Collins, and Kristina Toutanova. BoolQ: Exploring the surprising difficulty of natural yes/no questions. In Proceedings of NAACL-HLT, 2019.
[CLL ${ }^{+}$23] Wei-Lin Chiang, Zhuohan Li, Zi Lin, Ying Sheng, Zhanghao Wu, Hao Zhang, Lianmin Zheng, Siyuan Zhuang, Yonghao Zhuang, Joseph E. Gonzalez, Ion Stoica, and Eric P. Xing. Vicuna: An open-source chatbot impressing gpt-4 with $90 \%$ * chatgpt quality, March 2023.
[CND ${ }^{+}$22] Aakanksha Chowdhery, Sharan Narang, Jacob Devlin, Maarten Bosma, Gaurav Mishra, Adam Roberts, Paul Barham, Hyung Won Chung, Charles Sutton, Sebastian Gehrmann, et al. Palm: Scaling language modeling with pathways. arXiv preprint arXiv:2204.02311, 2022.
[CPO ${ }^{+}$19] Wojciech M Czarnecki, Razvan Pascanu, Simon Osindero, Siddhant Jayakumar, Grzegorz Swirszcz, and Max Jaderberg. Distilling policy distillation. In Proceedings of AISTATS, 2019.
[CvdS21] Alex James Chan and Mihaela van der Schaar. Scalable bayesian inverse reinforcement learning. In ICLR, 2021.
[FLT ${ }^{+}$18] Tommaso Furlanello, Zachary Lipton, Michael Tschannen, Laurent Itti, and Anima Anandkumar. Born again neural networks. In Proceedings of ICML, 2018.
[GCPT19] Aaron Gokaslan, Vanya Cohen, Ellie Pavlick, and Stefanie Tellex. Openwebtext corpus, 2019.
[Goo23] Google. Bard, 2023.
[GWS ${ }^{+}$23] Arnav Gudibande, Eric Wallace, Charlie Snell, Xinyang Geng, Hao Liu, Pieter Abbeel, Sergey Levine, and Dawn Song. The false promise of imitating proprietary llms. arXiv preprint arXiv:2305.15717, 2023.
[HBD ${ }^{+}$20] Ari Holtzman, Jan Buys, Li Du, Maxwell Forbes, and Yejin Choi. The curious case of neural text degeneration. In Proceedings of ICLR, 2020.</p>
<p>[HLM22] Yongchang Hao, Yuxin Liu, and Lili Mou. Teacher forcing recovers reward functions for text generation. In Proceeings of NeurIPS, 2022.
[HSLS23] Or Honovich, Thomas Scialom, Omer Levy, and Timo Schick. Unnatural instructions: Tuning language models with (almost) no human labor. In Proceedings of ACL, 2023.
[HTAL17] Tuomas Haarnoja, Haoran Tang, Pieter Abbeel, and Sergey Levine. Reinforcement learning with deep energy-based policies. In Proceedings of ICML, 2017.
[Hus15] Ferenc Huszár. How (not) to train your generative model: Scheduled sampling, likelihood, adversary? arXiv preprint arXiv:1511.05101, 2015.
[HVD15] Geoffrey Hinton, Oriol Vinyals, and Jeff Dean. Distilling the knowledge in a neural network. arXiv preprint arXiv:1503.02531, 2015.
$\left[\mathrm{HZD}^{+} 21\right]$ Xu Han, Zhengyan Zhang, Ning Ding, Yuxian Gu, et al. Pre-trained models: Past, present and future. AI Open, 2021.
[JBMD21] Gou Jianping, Yu Baosheng, Stephen J Maybank, and Tao Dacheng. Knowledge distillation: A survey. IJCV, 2021.
$\left[\mathrm{JHC}^{+} 20\right]$ Haoming Jiang, Pengcheng He, Weizhu Chen, Xiaodong Liu, Jianfeng Gao, and Tuo Zhao. Smart: Robust and efficient fine-tuning for pre-trained natural language models through principled regularized optimization. In Proceedings ACL, 2020.
$\left[\mathrm{JKH}^{+} 23\right]$ Haozhe Ji, Pei Ke, Zhipeng Hu, Rongsheng Zhang, and Minlie Huang. Tailoring language generation models under total variation distance. In Proceedings of ICLR, 2023.
$\left[\mathrm{JLF}^{+} 23\right]$ Ziwei Ji, Nayeon Lee, Rita Frieske, Tiezheng Yu, Dan Su, Yan Xu, Etsuko Ishii, Ye Jin Bang, Andrea Madotto, and Pascale Fung. Survey of hallucination in natural language generation. ACM Computing Surveys, 2023.
$\left[\mathrm{JYS}^{+} 20\right]$ Xiaoqi Jiao, Yichun Yin, Lifeng Shang, Xin Jiang, Xiao Chen, Linlin Li, Fang Wang, and Qun Liu. Tinybert: Distilling bert for natural language understanding. In Findings of EMNLP, 2020.
$\left[\mathrm{KMH}^{+} 20\right]$ Jared Kaplan, Sam McCandlish, Tom Henighan, Tom B Brown, Benjamin Chess, Rewon Child, Scott Gray, Alec Radford, Jeffrey Wu, and Dario Amodei. Scaling laws for neural language models. arXiv preprint arXiv:2001.08361, 2020.
[KR16] Yoon Kim and Alexander M Rush. Sequence-level knowledge distillation. In Proceedings of EMNLP, 2016.
$\left[\mathrm{LGB}^{+} 16\right]$ Jiwei Li, Michel Galley, Chris Brockett, Jianfeng Gao, and Bill Dolan. A diversitypromoting objective function for neural conversation models. In Kevin Knight, Ani Nenkova, and Owen Rambow, editors, Proceedings of NAACL, 2016.
$\left[\mathrm{LHS}^{+} 21\right]$ Kevin J Liang, Weituo Hao, Dinghan Shen, Yufan Zhou, Weizhu Chen, Changyou Chen, and Lawrence Carin. Mix{kd}: Towards efficient distillation of large-scale language models. In Proceedings of ICLR, 2021.
[Lin04] Chin-Yew Lin. ROUGE: A package for automatic evaluation of summaries. In Proceedings of Text Summarization Branches Out (ACL 2004), 2004.
[LKTF20] Sergey Levine, Aviral Kumar, George Tucker, and Justin Fu. Offline reinforcement learning: Tutorial, review, and perspectives on open problems. arXiv preprint arXiv:2005.01643, 2020.
[LLW ${ }^{+} 20$ ] Jianqiao Li, Chunyuan Li, Guoyin Wang, Hao Fu, Yuhchen Lin, Liqun Chen, Yizhe Zhang, Chenyang Tao, Ruiyi Zhang, Wenlin Wang, et al. Improving text generation with student-forcing optimal transport. In Proceedings of EMNLP, 2020.</p>
<p>[LOG+19] Yinhan Liu, Myle Ott, Naman Goyal, Jingfei Du, Mandar Joshi, Danqi Chen, Omer Levy, Mike Lewis, Luke Zettlemoyer, and Veselin Stoyanov. RoBERTa: A robustly optimized BERT pretraining approach. arXiv preprint arXiv:1907.11692, 2019.
[LPSK23] Hyoje Lee, Yeachan Park, Hyun Seo, and Myungjoo Kang. Self-knowledge distillation via dropout. Computer Vision and Image Understanding, 2023.
$\left[\mathrm{M}^{+}\right.$05] Tom Minka et al. Divergence measures and message passing. Technical report, Citeseer, 2005.
[MFL+20] Seyed Iman Mirzadeh, Mehrdad Farajtabar, Ang Li, Nir Levine, Akihiro Matsukawa, and Hassan Ghasemzadeh. Improved knowledge distillation via teacher assistant. In Proceedings of AAAI, 2020.
[MG19] Andrey Malinin and Mark Gales. Reverse KL-divergence training of prior networks: Improved uncertainty and adversarial robustness. In Proceedings of NeurIPS, 2019.
[NCT16] Sebastian Nowozin, Botond Cseke, and Ryota Tomioka. f-gan: Training generative neural samplers using variational divergence minimization. In Proceedings of NeurIPS, 2016.
$\left[\mathrm{NDZ}^{+}\right.$19] Jeremy Nixon, Michael W Dusenberry, Linchuan Zhang, Ghassen Jerfel, and Dustin Tran. Measuring calibration in deep learning. In CVPR workshops, 2019.
[Ope22] OpenAI. OpenAI: Introducing ChatGPT, 2022.
[Ope23] OpenAI. GPT-4 technical report, 2023.
[OWJ+22] Long Ouyang, Jeff Wu, Xu Jiang, Diogo Almeida, Carroll L Wainwright, Pamela Mishkin, Chong Zhang, Sandhini Agarwal, Katarina Slama, Alex Ray, et al. Training language models to follow instructions with human feedback. In Proceedings of NeurIPS, 2022.
[PH21] Richard Yuanzhe Pang and He He. Text generation by learning from demonstrations. In Proceedings of ICLR, 2021.
[PLH+23] Baolin Peng, Chunyuan Li, Pengcheng He, Michel Galley, and Jianfeng Gao. Instruction tuning with GPT-4. arXiv preprint arXiv:2304.03277, 2023.
[PSS00] Doina Precup, Richard S Sutton, and Satinder P Singh. Eligibility traces for off-policy policy evaluation. In Proceedings of ICML, 2000.
$\left[\mathrm{RCG}^{+}\right.$15] Andrei A Rusu, Sergio Gomez Colmenarejo, Caglar Gulcehre, Guillaume Desjardins, James Kirkpatrick, Razvan Pascanu, Volodymyr Mnih, Koray Kavukcuoglu, and Raia Hadsell. Policy distillation. arXiv preprint arXiv:1511.06295, 2015.
$\left[\mathrm{RWC}^{+}\right.$19] Alec Radford, Jeffrey Wu, Rewon Child, David Luan, Dario Amodei, and Ilya Sutskever. Language models are unsupervised multitask learners. OpenAI Technical report, 2019.
[SCGL19] Siqi Sun, Yu Cheng, Zhe Gan, and Jingjing Liu. Patient knowledge distillation for BERT model compression. In Proceedings EMNLP, 2019.
[SDCW19] Victor Sanh, Lysandre Debut, Julien Chaumond, and Thomas Wolf. DistilBERT, a distilled version of bert: smaller, faster, cheaper and lighter. arXiv preprint arXiv:1910.01108, 2019.
[SHKK22] Joar Max Viktor Skalse, Nikolaus HR Howe, Dmitrii Krasheninnikov, and David Krueger. Defining and characterizing reward gaming. In Proceedings of NeurIPS, 2022.
[SMSM99] Richard S Sutton, David McAllester, Satinder Singh, and Yishay Mansour. Policy gradient methods for reinforcement learning with function approximation. Proceedings of NeurIPS, 1999.</p>
<p>[SPW ${ }^{+}$13] Richard Socher, Alex Perelygin, Jean Wu, Jason Chuang, Christopher D. Manning, Andrew Ng, and Christopher Potts. Recursive deep models for semantic compositionality over a sentiment treebank. In Proceedings of EMNLP, October 2013.
[SSG ${ }^{+}$17] Iulian V Serban, Chinnadhurai Sankar, Mathieu Germain, Saizheng Zhang, Zhouhan Lin, Sandeep Subramanian, Taesup Kim, Michael Pieper, Sarath Chandar, Nan Rosemary Ke, et al. A deep reinforcement learning chatbot. arXiv preprint arXiv:1709.02349, 2017.
[SST ${ }^{+}$20] Kaitao Song, Hao Sun, Xu Tan, Tao Qin, Jianfeng Lu, Hongzhi Liu, and Tie-Yan Liu. LightPAFF: A two-stage distillation framework for pre-training and fine-tuning. arXiv preprint arXiv:2004.12817, 2020.
[SWD ${ }^{+}$17] John Schulman, Filip Wolski, Prafulla Dhariwal, Alec Radford, and Oleg Klimov. Proximal policy optimization algorithms. arXiv preprint arXiv:1707.06347, 2017.
[SWR ${ }^{+}$22] Victor Sanh, Albert Webson, Colin Raffel, Stephen H Bach, Lintang Sutawika, Zaid Alyafeai, et al. Multitask prompted training enables zero-shot task generalization. In Proceedings of ICLR, 2022.
[TDFH ${ }^{+}$22] Romal Thoppilan, Daniel De Freitas, Jamie Hall, Noam Shazeer, Apoorv Kulshreshtha, Heng-Tze Cheng, Alicia Jin, Taylor Bos, Leslie Baker, Yu Du, et al. Lamda: Language models for dialog applications. arXiv preprint arXiv:2201.08239, 2022.
[TGZ ${ }^{+}$23] Rohan Taori, Ishaan Gulrajani, Tianyi Zhang, Yann Dubois, Xuechen Li, Carlos Guestrin, Percy Liang, and Tatsunori B. Hashimoto. Stanford Alpaca: An instructionfollowing LLaMA model. https://github.com/tatsu-lab/stanford_alpaca, 2023.
[TLI ${ }^{+}$23] Hugo Touvron, Thibaut Lavril, Gautier Izacard, Xavier Martinet, Marie-Anne Lachaux, Timothée Lacroix, Baptiste Rozière, Naman Goyal, Eric Hambro, Faisal Azhar, Aurelien Rodriguez, Armand Joulin, Edouard Grave, and Guillaume Lample. LLaMA: Open and efficient foundation language models. arXiv preprint arXiv:2302.13971, 2023.
[TWS18] Faraz Torabi, Garrett Warnell, and Peter Stone. Behavioral cloning from observation. In Proceedings of IJCAI, 2018.
$\left[\mathrm{WBH}^{+}\right.$21] Wenhui Wang, Hangbo Bao, Shaohan Huang, Li Dong, and Furu Wei. MiniLMv2: Multi-head self-attention relation distillation for compressing pretrained transformers. In Findings of ACL, 2021.
[WBZ ${ }^{+}$22] Jason Wei, Maarten Bosma, Vincent Y Zhao, Kelvin Guu, Adams Wei Yu, Brian Lester, Nan Du, Andrew M Dai, and Quoc V Le. Finetuned language models are zero-shot learners. In Proceedings of ICLR, 2022.
[Wil92] Ronald J Williams. Simple statistical gradient-following algorithms for connectionist reinforcement learning. Machine learning, 1992.
[WK21] Ben Wang and Aran Komatsuzaki. GPT-J-6B: A 6 Billion Parameter Autoregressive Language Model, 2021.
[WKM ${ }^{+}$23] Yizhong Wang, Yeganeh Kordi, Swaroop Mishra, Alisa Liu, Noah A. Smith, Daniel Khashabi, and Hannaneh Hajishirzi. Self-instruct: Aligning language models with self-generated instructions. In Proceedings of ACL, 2023.
[WLDM23] Yuqiao Wen, Zichao Li, Wenyu Du, and Lili Mou. f-divergence minimization for sequence-level knowledge distillation. In Proceedings of ACL, 2023.
[WMA ${ }^{+}$22] Yizhong Wang, Swaroop Mishra, Pegah Alipoormolabashi, Yeganeh Kordi, Amirreza Mirzaei, Anjana Arunkumar, Arjun Ashok, Arut Selvan Dhanasekaran, Atharva Naik, David Stap, et al. Benchmarking generalization via in-context instructions on 1,600+ language tasks. In Proceedings of EMNLP, 2022.</p>
<p>[WTB+22] Jason Wei, Yi Tay, Rishi Bommasani, Colin Raffel, Barret Zoph, Sebastian Borgeaud, Dani Yogatama, Maarten Bosma, Denny Zhou, Donald Metzler, et al. Emergent abilities of large language models. Transactions on Machine Learning Research, 2022.
[WWD+20] Wenhui Wang, Furu Wei, Li Dong, Hangbo Bao, Nan Yang, and Ming Zhou. MiniLM: Deep self-attention distillation for task-agnostic compression of pre-trained transformers. In Proceedings of NeurIPS, 2020.
[WWZ+23] Minghao Wu, Abdul Waheed, Chiyu Zhang, Muhammad Abdul-Mageed, and Alham Fikri Aji. Lamini-lm: A diverse herd of distilled models from large-scale instructions. arXiv preprint arXiv:2304.14402, 2023.
[ZCS+23] Lianmin Zheng, Wei-Lin Chiang, Ying Sheng, Siyuan Zhuang, Zhanghao Wu, Yonghao Zhuang, Zi Lin, Zhuohan Li, Dacheng Li, Eric Xing, et al. Judging llm-as-a-judge with mt-bench and chatbot arena. In Proceedings of NeurIPS, 2023.
[ZLX+23] Chunting Zhou, Pengfei Liu, Puxin Xu, Srinivasan Iyer, Jiao Sun, Yuning Mao, Xuezhe Ma, Avia Efrat, Ping Yu, Lili Yu, et al. LIMA: Less is more for alignment. In Proceedings of NeurIPS, 2023.
[ZMB+08] Brian D Ziebart, Andrew L Maas, J Andrew Bagnell, Anind K Dey, et al. Maximum entropy inverse reinforcement learning. In Proceedings of AAAI, 2008.
[ZRG+22] Susan Zhang, Stephen Roller, Naman Goyal, Mikel Artetxe, Moya Chen, Shuohui Chen, Christopher Dewan, Mona Diab, Xian Li, Xi Victoria Lin, et al. OPT: Open pre-trained transformer language models. arXiv preprint arXiv:2205.01068, 2022.
[ZSL+23] Rongzhi Zhang, Jiaming Shen, Tianqi Liu, Jialu Liu, Michael Bendersky, Marc Najork, and Chao Zhang. Do not blindly imitate the teacher: Using perturbed loss for knowledge distillation. arXiv preprint arXiv:2305.05010, 2023.
[ZZ19] Huan Zhang and Hai Zhao. Minimum divergence vs. maximum margin: an empirical comparison on seq2seq models. In International Conference on Learning Representations, 2019.</p>
<h1>A Derivations</h1>
<h2>A. 1 A Perspective of MiniLLM from Inverse Reinforcement Learning</h2>
<p>In Section 2.1, we formulate KD as an optimization problem of minimizing the discrepancy between the teacher distribution and the student distribution and finally reach the objective of minimizing reverse KLD. Alternatively, we can also regard KD as training the student model with the teacher model's guidance, which resembles an agent learning from the feedback from an environment. Following [PH21], we treat token generation as a Markov Decision Process. At each time step $t$, the student model chooses an action (token) $y_{t}$ from the action space (vocabulary) $V$ conditioning on the state (prefix) $\left(\boldsymbol{y}<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)$ based on the policy (generation probability) $q</em>}\left(y_{t} \mid \boldsymbol{y<em t="t">{&lt;t}, \boldsymbol{x}\right)$.
From this perspective, standard KD corresponds to behavior cloning (BC; TWS18) in imitation learning [Cio21]. However, BC is known to under-perform Inverse Reinforcement Learning (IRL; ZMB ${ }^{+} 08$ ), another imitation learning method that first recovers a reward model from the environment demonstrations and then trains the policy with the reward using policy optimization algorithms [SMSM99, SWD ${ }^{+} 17$ ]. Therefore, in the KD scenario, we seek to first induce a reward $r\left(y</em>},\left(\boldsymbol{y<em t="t">{&lt;t}, \boldsymbol{x}\right)\right)$ from the environment (the teacher model) and then train the student model to maximize the reward as the objective. We take the maximum-entropy inverse reinforcement learning framework [ZMB ${ }^{+} 08$, CvdS21] and thus the Q-function $Q\left(y</em>\right)\right)$ in the environment satisfies the soft Bellman Equation:},\left(\boldsymbol{y}_{&lt;t}, \boldsymbol{x</p>
<p>$$
Q\left(y_{t},\left(\boldsymbol{y}<em t="t">{&lt;t}, \boldsymbol{x}\right)\right)=r\left(y</em>},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)+\gamma \log \sum</em>\right)\right)\right]
$$} \in V} \exp \left[Q\left(y^{\prime},\left(\boldsymbol{y}_{\leq t}, \boldsymbol{x</p>
<p>We follow [HLM22] to parameterize the Q-function as $Q\left(y_{t},\left(\boldsymbol{y}<em t="t">{&lt;t}, \boldsymbol{x}\right)\right)=f\left(y</em>},\left(\boldsymbol{y<em t="t">{&lt;t}, \boldsymbol{x}\right)\right)$ and assume $\gamma=1$, where $f\left(y</em>$. Then, the reward is given by:},\left(\boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)\right)$ is the output logits of the teacher model ${ }^{6</p>
<p>$$
r\left(y_{t},\left(\boldsymbol{y}<em t="t">{&lt;t}, \boldsymbol{x}\right)\right)=f\left(y</em>},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)-\log \sum</em>\right)\right)\right]
$$} \in V} \exp \left[f\left(y^{\prime},\left(\boldsymbol{y}_{\leq t}, \boldsymbol{x</p>
<p>To maximize the reward, we apply maximum-entropy reinforcement learning [HTAL17], whose learning objective is</p>
<p>$$
\max <em _theta="\theta">{\theta} \mathcal{J}(\theta)=\max </em>} \underset{\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{|\boldsymbol{y}|}\left[r\left(y_{t},\left(\boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)\right)+\mathrm{H}\left[q</em>)\right]\right]
$$}(\cdot \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x</p>
<p>where $\mathrm{H}\left[q_{\theta}(\cdot \mid \boldsymbol{y}<em y__t="y_{t">{&lt;t}, \boldsymbol{x})\right]=-\mathbb{E}</em>} \sim q_{\theta}(\cdot \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x})} \log q</em>)$ is the entropy of the student model distribution at the time step $t$.}(\cdot \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x</p>
<p>Equivalence Between Objectives We prove an approximate equivalence between Eq. 10 and Eq. 1. We first rewrite the summation of the reward $\sum_{t=1}^{|\boldsymbol{y}|} r\left(y_{t},\left(\boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)\right)$ by the associative law:</p>
<p>$$
\begin{aligned}
\sum_{t=1}^{|\boldsymbol{y}|} r\left(y_{t},\left(\boldsymbol{y}<em t="1">{&lt;t}, \boldsymbol{x}\right)\right)= &amp; \sum</em>}^{|\boldsymbol{y}|}\left[f\left(y_{t},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)-\log \sum</em>} \in V} \exp \left[f\left(y^{\prime},\left(\boldsymbol{y<em 1="1">{\leq t}, \boldsymbol{x}\right)\right)\right]\right] \
= &amp; f\left(y</em>},\left(\boldsymbol{y<em t="2">{&lt;1}, \boldsymbol{x}\right)\right)+\sum</em>}^{|\boldsymbol{y}|}\left[f\left(y_{t},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)-\log \sum</em>} \in V} \exp \left[f\left(y^{\prime},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)\right]\right] \
&amp; -\log \sum</em>} \in V} \exp \left[f\left(y^{\prime},\left(\boldsymbol{y<em t="1">{\leq \mid \boldsymbol{y} \mid}, \boldsymbol{x}\right)\right)\right] \
\approx &amp; \sum</em>}^{|\boldsymbol{y}|}\left[f\left(y_{t},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)-\log \sum</em>} \in V} \exp \left[f\left(y^{\prime},\left(\boldsymbol{y<em t="1">{&lt;t}, \boldsymbol{x}\right)\right)\right]\right] \
= &amp; \sum</em>}^{|\boldsymbol{y}|} \log \frac{\exp \left(f\left(y_{t},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)\right)}{\sum</em>} \in V} \exp \left(f\left(y^{\prime},\left(\boldsymbol{y<em t="1">{&lt;t}, \boldsymbol{x}\right)\right)\right)} \
= &amp; \sum</em>\right)
\end{aligned}
$$}^{|\boldsymbol{y}|} \log p\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x</p>
<p><sup id="fnref4:0"><a class="footnote-ref" href="#fn:0">1</a></sup></p>
<p>Then, $\mathcal{J}(\theta)$ can be approximately rewritten as:</p>
<p>$$
\begin{aligned}
\mathcal{J}(\theta) &amp; \approx \underset{\boldsymbol{x} \sim p_{\theta}}{\mathbb{E}} \sum_{t=1}^{|\boldsymbol{y}|}\left[\log p\left(y_{t} \mid \boldsymbol{y}<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)+\mathrm{H}\left[q</em>}\left(\cdot \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)\right]\right] \
&amp; =\underset{\boldsymbol{y} \sim q</em>}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{|\boldsymbol{y}|}\left[\log p\left(y_{t} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)-\log \left[q</em>}\left(\cdot \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)\right]\right] \
&amp; =-\mathrm{KL}\left(q</em> | p\right) \
&amp; =-\mathcal{L}(\theta)
\end{aligned}
$$</p>
<p>Therefore, maximizing $\mathcal{J}(\theta)$ is approximately equivalent to minimizing $\mathcal{L}(\theta)$.</p>
<h1>A. 2 Derivation of Equation 2</h1>
<p>We compute the gradient of $\mathcal{L}(\theta)=\mathrm{KL}\left[q_{\theta} | p\right]$ with respect to $\theta$ using the Policy Gradient Theorem [SMSM99]:</p>
<p>$$
\begin{aligned}
\nabla \mathcal{L}(\theta) &amp; =-\nabla \underset{\substack{\boldsymbol{x} \sim p_{\boldsymbol{x}}} \
\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \log \frac{p(\boldsymbol{y} \mid \boldsymbol{x})}{q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x})} \
&amp; =-\int \nabla\left[q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \log \frac{p(\boldsymbol{y} \mid \boldsymbol{x})}{q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x})}\right] \mathrm{d} \boldsymbol{y} \mathrm{~d} \boldsymbol{x} \
&amp; =-\int q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \nabla \log \frac{p(\boldsymbol{y} \mid \boldsymbol{x})}{q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x})} \mathrm{d} \boldsymbol{y} \mathrm{~d} \boldsymbol{x}-\int \log \frac{p(\boldsymbol{y} \mid \boldsymbol{x})}{q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x})} \nabla q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \mathrm{d} \boldsymbol{y} \mathrm{~d} \boldsymbol{x} \
&amp; =\int q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \nabla \log q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \mathrm{d} \boldsymbol{y} \mathrm{~d} \boldsymbol{x}-\int q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \log \frac{p(\boldsymbol{y} \mid \boldsymbol{x})}{q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x})} \nabla \log q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \mathrm{d} \boldsymbol{y} \mathrm{~d} \boldsymbol{x} \
&amp; =-\underset{\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}}\left(\log \frac{p(\boldsymbol{y} \mid \boldsymbol{x})}{q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x})}-1\right) \nabla \log q_{\theta}(\boldsymbol{y} \mid \boldsymbol{x}) \
&amp; =-\underset{\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T}\left(\sum_{t^{\prime}=1}^{T} \log \frac{p\left(y_{t^{\prime}} \mid \boldsymbol{y}<em _theta="\theta">{&lt;t^{\prime}}, \boldsymbol{x}\right)}{q</em>}\left(y_{t^{\prime}} \mid \boldsymbol{y<em _theta="\theta">{&lt;t^{\prime}}, \boldsymbol{x}\right)}-1\right) \nabla \log q</em>}\left(y_{t} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right) \
&amp; =-\underset{\boldsymbol{y} \sim q</em>}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T}\left(\sum_{t^{\prime}=t}^{T} \log \frac{p\left(y_{t^{\prime}} \mid \boldsymbol{y<em _theta="\theta">{&lt;t^{\prime}}, \boldsymbol{x}\right)}{q</em>}\left(y_{t^{\prime}} \mid \boldsymbol{y<em _theta="\theta">{&lt;t^{\prime}}, \boldsymbol{x}\right)}-1\right) \nabla \log q</em>\right)
\end{aligned}
$$}\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x</p>
<p>where Eq. 21 is based on the fact that $\log q_{\theta}\left(y_{t} \mid \boldsymbol{y}<em t="t">{&lt;t}, \boldsymbol{x}\right)$ can only affect tokens at $\geq t$ positions in $\boldsymbol{y}$. By setting $R</em>}=\sum_{t^{\prime}=t}^{T} \log \frac{p\left(y_{t^{\prime}} \mid \boldsymbol{y<em _theta="\theta">{&lt;t^{\prime}}, \boldsymbol{x}\right)}{q</em>$, we obtain Eq. 2.}\left(y_{t^{\prime}} \mid \boldsymbol{y}_{&lt;t^{\prime}}, \boldsymbol{x}\right)</p>
<h2>A. 3 Derivation of Equation 3</h2>
<p>To derive Eq. 3, we first denote:</p>
<p>$$
\begin{aligned}
(\nabla \mathcal{L})<em _boldsymbol_x="\boldsymbol{x">{\text {Single }} &amp; =-\underset{\substack{\boldsymbol{x} \sim p</em> \
\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}}{\mathbb{E}}\left[\sum_{t=1}^{T} \nabla \underset{y_{t} \sim q_{\theta}(t)}{\mathbb{E}}\left[r_{t}\right]\right] \
(\nabla \mathcal{L})}}<em _boldsymbol_x="\boldsymbol{x">{\text {Long }} &amp; =-\underset{\substack{\boldsymbol{x} \sim p</em> \
\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}}{\mathbb{E}} \sum_{t=1}^{T} R_{t+1} \nabla \log q_{\theta}\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)
\end{aligned}
$$}}</p>
<p>Then, we re-write $\nabla \mathcal{L}(\theta)$ as:</p>
<p>$$
\begin{aligned}
\nabla \mathcal{L}(\theta)= &amp; -\underset{\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T}\left(R_{t}-1\right) \nabla \log q_{\theta}\left(y_{t} \mid \boldsymbol{y}<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right) \
= &amp; -\underset{\boldsymbol{y} \sim q</em>}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T} R_{t+1} \nabla \log q_{\theta}\left(y_{t} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right) \
&amp; -\underset{\boldsymbol{y} \sim q</em>}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T}\left(\log \frac{p\left(y_{t} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}{q</em>}\left(y_{t} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}-1\right) \nabla \log q</em>}\left(y_{t} \mid \boldsymbol{y<em _Long="{Long" _text="\text">{&lt;t}, \boldsymbol{x}\right) \
= &amp; (\nabla \mathcal{L})</em>}}-\underset{\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T} \underset{q_{t} \sim q_{\theta}\left(\cdot \mid \boldsymbol{y<em t="t">{&lt;t}, \boldsymbol{x}\right)}{\mathbb{E}}\left(\log \frac{p\left(y</em>} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}{q</em>}\left(y_{t} \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}-1\right) \nabla \log q</em>}\left(y_{t} \mid \boldsymbol{y<em _Long="{Long" _text="\text">{&lt;t}, \boldsymbol{x}\right) \
= &amp; (\nabla \mathcal{L})</em>}}-\underset{\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}} \sum_{t=1}^{T} \nabla \underset{\substack{y_{t} \sim q_{\theta}\left(\cdot \mid \boldsymbol{y<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}}{\mathbb{E}}\left[-\log \frac{q</em>}\left(y_{t} \mid \boldsymbol{y<em t="t">{&lt;t}, \boldsymbol{x}\right)}{p\left(y</em>} \mid \boldsymbol{y<em _Long="{Long" _text="\text">{&lt;t}, \boldsymbol{x}\right)}\right] \
= &amp; (\nabla \mathcal{L})</em>\right]\right] \
= &amp; (\nabla \mathcal{L})}}-\underset{\boldsymbol{y} \sim q_{\theta}(\cdot \mid \boldsymbol{x})}{\mathbb{E}}\left[\sum_{t=1}^{T} \nabla \underset{y_{t} \sim q_{\theta}(t)}{\mathbb{E}}\left[r_{t<em _Single="{Single" _text="\text">{\text {Long }}+(\nabla \mathcal{L})</em>,
\end{aligned}
$$}</p>
<p>where Eq. 27 uses the product rule of the gradient and $r_{t}=\log \frac{p\left(y_{t} \mid \boldsymbol{y}<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}{q</em>$.}\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)</p>
<h1>B Experimental Details</h1>
<h2>B. 1 Training Details</h2>
<p>Baselines Our baselines include SFT w/o KD, KD, and SeqKD. For models with less than 1.3B parameters, we search for the learning rates in [5e-4, 1e-4, 5e-5], the batch sizes in [32, 64], and train these models for 20 epochs. For other models, we search for the learning rate in [5e-5, 1e5, 5e-6], the batch sizes in [32, 64], and train these models for 10 epochs. For KD, we follow [SST $\left.{ }^{+} 20\right]$ to mix the distillation loss with the language modeling loss on the ground truth responses by a mixture rate of 0.5 . The checkpoints of each baseline are selected by the Rouge-L [Lin04] scores on the validation set because, as stated in previous works [WMA ${ }^{+} 22, \mathrm{OWJ}^{+}$22], we also find that Rouge-L is better correlated with human judgments.</p>
<p>MinILLM As stated in Section 2.3, training of MinILLM has two phases which is similar to Reinforcement Learning from Human Feedback (RLHF;OWJ ${ }^{+} 22$ ).</p>
<ul>
<li>Phase 1: We fine-tune the student model on the instruction-response training set $\mathcal{D}$ to get a starting point for the subsequent MinILLM training. We fine-tune the model for 3 epochs using the best learning rate and batch size of the corresponding SFT w/o KD baselines. Note that different from the SFT w/o KD baseline, we select the checkpoint with the lowest validation loss, not the Rouge-L score in this phase.</li>
<li>Phase 2: We continuously train the model from Phase 1 as described in Algorithm 2.3 using a learning rate 5e-6, a mini-batch size 64 in all cases. The training and validation set are same as in Phase 1. Similar to [OWJ $\left.{ }^{+} 22\right]$, we collect 256 sentences at once and adopt 4 inner epochs when doing the policy optimization. The clipping rate $\epsilon$ is set to 0.2 , and the max length of the model is 512 . We use temperature $=1$ when sampling from $q_{\theta}$. We train the model for 5000 steps and select the final checkpoint using the Rouge-L score on the validation set. Our experiments are based on the NVIDIA V100 32G GPUs. Distilling LLaMA-7B from LLaMA-13B takes less than 10 ours on 16 GPUs.</li>
</ul>
<h2>B. 2 Automatic Evaluation Details</h2>
<p>During the evaluation, we sample the responses from each model using temperature $=1$, a maxlength limit of 512 , and random seeds $[10,20,30,40,50]$. Similar to [TGZ $\left.{ }^{+} 23\right]$, we adopt a prompt wrapper shown in Figure 9 to convert each instruction-response pair to a sentence. For the GPT-4</p>
<p>Below is an instruction that describes a task.
Write a response that appropriately completes the request.
### Instruction:
{instruction}
### Input:
{input}
### Response:</p>
<p>Figure 9: The prompt wrapper for training and evaluation.</p>
<p>We would like to request your feedback on the performance of two AI assistants in response to the user instruction and input displayed above.
Please rate the helpfulness, relevance, accuracy, and level of detail of their responses. Each assistant receives an overall score on a scale of 1 to 10 , where a higher score indicates better overall performance.
Please first output a single line containing only two values indicating the scores for Assistant 1 and 2, respectively. The two scores are separated by a space.
In the subsequent line, please provide a comprehensive explanation of your evaluation, avoiding any potential bias and ensuring that the order in which the responses were presented does not affect your judgment.</p>
<p>Figure 10: GPT-4 evaluation prompt.
feedback, we apply the prompt in Figure 10 and set the temperature $=0.7$. For the classification tasks in the "Calibration" paragraph of Section 3.3, we prompt the model to do zero-shot text classification with the templates in Figure 11 and 12.</p>
<h1>B. 3 Human Evaluation Details</h1>
<p>Following [PLH+23], we use SelfInst [WKM+23] to perform human evaluation. We randomly sampled 50 prompts because we found that more prompts do not affect the results much. We ask the annotators to compare the responses generated by the baseline models with MiniLLM and decide which response is preferred or neither of them is significantly better. Note that which model the responses come from is invisible to the annotators. The interface presented to annotators is shown in Figure 13.</p>
<p>Below is an instruction that describes a task.
Write a response that appropriately completes the request.
### Instruction:
Determine the sentiment of the input sentence. Please respond as positive or negative.
### Input:
{sentence}
### Response:</p>
<p>Figure 11: Zero-shot text classification prompt for SST2.</p>
<p>Below is an instruction that describes a task.
Write a response that appropriately completes the request.
### Instruction:
Read the input passage and answer the question: {question}? Your answer should be "Yes" or "No".
### Input:
{passage}
### Response:</p>
<p>Figure 12: Zero-shot text classification prompt for BoolQ.</p>
<p>Below is an instruction that describes a task, paired with an input that provides further context. Write a response that appropriately completes the request.
### Instruction:
Desk jobs require writing a lot of emails, so it isn't surprising we get tired of repeating ourselves. Come up with several synonyms for the given word.
### Input:
Sincerely
### Response:
##### Answer #1 #####
Fondly, affectionately, lovingly, tenderly, honestly, truly, faithfully, devotedly, passionately
##### Answer #2 #####
Faithfully, Gullibly, Humbly, Piously, Strangely, Weirdly, Yours truly
1: Answer #1 is better
2: Answer #2 is better
3: Tie
Your choice:</p>
<p>Figure 13: The prompt wrapper for training and evaluation.</p>
<h1>B. 4 Details About Generation Diversity Metrics</h1>
<p>In Table 3, we report the distinct 4-grams (Dist-4) and the language modeling loss (Loss) on the test sets. More details about these two metrics are as follows:</p>
<ul>
<li>"Dist-4" is a fraction: $N / C$, where $N$ is the number of the distinct 4-grams in the generated responses and $C$ is the total number of 4-grams. It is a widely used metric to measure the generation diversity of a language model [LGB ${ }^{+} 16$ ]. The $(N / C)$ s on the Dolly test set across 5 random seeds are shown in Table 5. Table 3 reports the average values across the 5 random seeds.</li>
<li>"Loss" is the negative log-likelihood loss on the test set $\mathcal{D}<em _boldsymbol_x="\boldsymbol{x">{\text {Test }}:-\sum</em>}, \boldsymbol{y} \sim \mathcal{D<em _theta="\theta">{\text {Test }}} \log q</em>)$. It measures the mode coverage of the real data distribution because it is essentially the forward KLD between the real data distribution and the model output distribution. This relates to diversity as in the ability to generate different generations given one context with different random seeds.}(\boldsymbol{y} \mid \boldsymbol{x</li>
</ul>
<table>
<thead>
<tr>
<th>Seed</th>
<th>10</th>
<th>20</th>
<th>30</th>
<th>40</th>
<th>50</th>
</tr>
</thead>
<tbody>
<tr>
<td>Teacher</td>
<td>23562 / 23696</td>
<td>23653 / 23834</td>
<td>24306 / 24488</td>
<td>24207 / 24381</td>
<td>23803 / 23967</td>
</tr>
<tr>
<td>KD</td>
<td>25889 / 26064</td>
<td>24024 / 24197</td>
<td>25663 / 25843</td>
<td>25611 / 25763</td>
<td>26178 / 26339</td>
</tr>
<tr>
<td>SeqKD</td>
<td>25358 / 25519</td>
<td>25631 / 25822</td>
<td>26190 / 26370</td>
<td>25574 / 25748</td>
<td>26295 / 26522</td>
</tr>
<tr>
<td>MinILLM</td>
<td>24187 / 24458</td>
<td>25011 / 25272</td>
<td>25100 / 25436</td>
<td>24067 / 24312</td>
<td>25205 / 25519</td>
</tr>
</tbody>
</table>
<p>Table 5: The $(N / C)$ s, where $N$ is the number of the distinct 4-grams in the generated responses and $C$ is the total number of 4-grams. We report the numbers computed on the Dolly test set when evaluated with 5 random seeds: $[10,20,30,40,50]$.
<img alt="img-7.jpeg" src="img-7.jpeg" /></p>
<p>Figure 14: The scaling law of teacher model based on the OPT family models. We compare MinILLM and SeqKD with OPT-1.3M as the student and OPT 2.7B, 6.7B, and 13B as teachers.
<img alt="img-8.jpeg" src="img-8.jpeg" /></p>
<p>Figure 15: The Rouge-L scores of the distilled models against the SFT models on the different evaluation subsets of UnNI split by the golden responses' length.</p>
<h1>B. 5 Exposure Bias Analysis</h1>
<p>Following [AEABC22], we compute the ExAccErr with the following formula:</p>
<p>$$
\operatorname{ExAccErr}(l)=\frac{R(l)-l \epsilon(l)}{l \epsilon(l)} \times 100 \%
$$</p>
<p>where $R(l)$ is the accumulated regret of imitating the teacher distribution $p$ at the time step $l$ during the free-run generation:</p>
<p>$$
R(l)=\sum_{t=1}^{T} \underset{\substack{\boldsymbol{y}&lt;t \sim q_{\theta}(\cdot \mid \boldsymbol{x}) \ y_{t} \sim p(\cdot \mid \boldsymbol{y}&lt;t, \boldsymbol{x})}}{\mathbb{E}} \log \frac{p\left(y_{t} \mid \boldsymbol{y}<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}{q</em>
$$}\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)</p>
<p>and $\epsilon(l)$ is the average per-step error between $q_{\theta}$ and $p$ using the oracle context sampled from $p$ as the prefix:</p>
<p>$$
\epsilon(l)=\frac{1}{l} \sum_{t=1}^{T} \underset{\substack{\boldsymbol{y}&lt;t \sim p(\cdot \mid \boldsymbol{x}) \ y_{t} \sim p(\cdot \mid \boldsymbol{y}&lt;t, \boldsymbol{x})}}{\mathbb{E}} \log \frac{p\left(y_{t} \mid \boldsymbol{y}<em _theta="\theta">{&lt;t}, \boldsymbol{x}\right)}{q</em>
$$}\left(y_{t} \mid \boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)</p>
<p>Intuitively, the regret of $q_{\theta}$ during generation is made of two parts: the error to estimate $p$ given the oracle context and the error caused by the low-quality model-generated prefix. The former is calculated by $l \epsilon(l)$, and the latter reflects the exposure bias. Therefore, ExAccErr measures the relative error caused only by exposure bias.</p>
<h2>C Additional Results</h2>
<h2>C. 1 GPT-J as the Teacher Model</h2>
<p>We present the evaluation results when using GPT-J as the teacher model and GPT-2-760M, GPT-21.5B, and GPT-Neo-2.7B [BLW ${ }^{+} 21$ ] as the student models in Table 6. MinILLM outperforms the baselines in most cases.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:0">
<p>${ }^{6}$ The teacher model's distribution satisifies $p\left(y_{t} \mid \boldsymbol{y}<em t="t">{&lt;t}, \boldsymbol{x}\right)=\frac{\exp \left(f\left(y</em>},\left(\boldsymbol{y<em y_prime="y^{\prime">{&lt;t}, \boldsymbol{x}\right)\right)\right)}{\sum</em>$.&#160;} \in V} \exp \left(f\left(y^{\prime},\left(\boldsymbol{y}_{&lt;t}, \boldsymbol{x}\right)\right)\right)<a class="footnote-backref" href="#fnref:0" title="Jump back to footnote 1 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2:0" title="Jump back to footnote 1 in the text">&#8617;</a><a class="footnote-backref" href="#fnref3:0" title="Jump back to footnote 1 in the text">&#8617;</a><a class="footnote-backref" href="#fnref4:0" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>We say "approximately" because for word-level KD, $\boldsymbol{y}$ is sampled from the real distribution, not the teacher distribution. For a strong enough teacher model, we can consider the two distributions approximately the same.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>            </div>
        </div>

    </div>
</body>
</html>